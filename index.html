<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weekly Agendas — Drive AppData + Optional Gist Backup</title>
<style>
  :root{ --ink:#111; --muted:#666; --link:#2166c2; --ring:#1697BB; --bg:#fff; --border:#e5e7eb; }
  html,body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--ink); background:#fff; margin:0}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px; position:relative}

  header{display:flex;align-items:center;justify-content:space-between;gap:24px;margin-bottom:16px}
  .title-underline{
    font-weight:800; letter-spacing:.2px; font-size:28px; display:inline-block;
    padding-bottom:8px; border-bottom:10px solid #111; line-height:1.15; margin:0; white-space:nowrap;
  }
  .iconBtn{border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; margin-left:16px;}
  .iconBtn svg{width:18px;height:18px}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 18px}
  .btn{border:1px solid var(--ring); color:#084b5a; padding:8px 12px; border-radius:10px; background:#e9f6fb; cursor:pointer; font-weight:600; margin:4px}
  .btn.secondary{border-color:#ddd;background:#fafafa;color:#222}
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .pill{font-size:12px; border:1px solid #ddd; padding:2px 8px; border-radius:999px; color:#333; background:#fafafa}
  .err{color:#b91c1c}

  .empty{padding:20px 24px; border:1px dashed var(--border); border-radius:12px; color:#555; background:#fafafa; white-space:nowrap; overflow-x:auto; width:fit-content; max-width:min(90vw, 620px); display:block; margin:8px 0; box-sizing:border-box; text-align:left;}

  .sectionRule{ height:2px; background:#d1d5db; width:min(420px, 90%); margin:18px auto 6px; border-radius:2px; }

  .grid{border:2px solid #000; border-collapse:collapse; width:100%}
  .grid th,.grid td{border:1px solid #000; padding:10px 12px; vertical-align:top}
  .grid th{font-weight:700; text-align:left; background:#fafafa}
  .sub{font-size:12px;color:#444;margin-top:2px}
  .note{font-size:13px;color:#444;line-height:1.35; white-space:pre-wrap}
  .note.isEditing{ outline:2px solid rgba(234,179,8,.6); background:#FFFBEB; border-radius:6px; padding:4px; }

  .weekHdr{display:flex; align-items:baseline; gap:12px; margin:28px 0 8px}
  .wkTitle{font-weight:800; font-size:18px}
  .wkLabel{font-weight:400; font-size:16px; white-space:nowrap}

  .badge{ border:1px solid transparent; background:#eee; color:#111; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; }
  .badge--current{  border-color:#0a7e2a33; background:#e8f8ed; color:#0f5c26; }
  .badge--upcoming{ border-color:#1d4ed833; background:#e6f0ff; color:#1d4ed8; }
  .badge--past{     border-color:#b91c1c33; background:#ffecec; color:#b91c1c; }

  .link{color:var(--link); text-decoration:underline; cursor:pointer}
  .muted{color:#666}
  .dblHint{ font-size:11px; color:#9CA3AF; margin-top:4px; }

  input[type="search"], input[type="text"], select, input[type="number"], input[type="date"]{
    border:1px solid #ccc; border-radius:10px; padding:8px 10px; width:140px; min-width:120px; outline:none; background:#fff;
  }
  input.long{width:260px} input.half{width:130px} input.full{width:100%} input::placeholder{ color:#888; }
  input:focus, select:focus{border-color:var(--ring); box-shadow:0 0 0 3px #1697bb33}
  #yearInput{ width:6.5ch; min-width:5.5ch; max-width:8ch; }

  .results{margin-top:8px; border:1px solid #e5e5e5; border-radius:10px; overflow:hidden}
  .resultItem{padding:10px 12px; border-top:1px solid #efefef; display:flex; justify-content:space-between; align-items:center; gap:12px}
  .resultItem:first-child{border-top:none}
  .slideTitle{font-size:13px; color:#333}
  .slideMeta{font-size:12px; color:#777}
  .choose{padding:8px 12px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; margin:4px}
  .slidesList{border-top:1px solid #eee; margin-top:8px; padding-top:8px}
  .slideRow{display:grid; grid-template-columns: 140px 1fr auto; align-items:center; gap:12px; padding:8px 0; border-top:1px dashed #eee}
  .slideRow:first-child{border-top:none}
  .thumb{ width:140px; height:79px; border:1px solid #e5e7eb; border-radius:8px; object-fit:cover; background:#f3f4f6; }
  .thumb.skel{ animation: pulse 1.2s ease-in-out infinite; filter: saturate(.2) blur(.2px); }
  @keyframes pulse { 0%{opacity:.65} 50%{opacity:1} 100%{opacity:.65} }

  .modalBackdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50;}
  .modal{ width:min(980px,92vw); background:#fff; border-radius:16px; border:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,.15); }
  .modal header{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center}
  .modal h2{margin:0; font-size:18px}
  .modal .body{padding:16px}

  .topCols{display:grid; grid-template-columns: 1fr 1fr; column-gap:6px; row-gap:10px; align-items:start; margin-bottom:8px;}
  @media (max-width:720px){ .topCols{ grid-template-columns:1fr; } }
  .fieldsForm{display:flex; flex-direction:column; gap:8px;}
  .fRow{display:grid; grid-template-columns:110px 1fr; align-items:center; gap:6px;}
  .fRow label{font-size:13px; color:#333; text-align:center; white-space:nowrap;}
  .fieldsForm.compact .fRow{ grid-template-columns:100px 1fr; }

  .twoCols{display:grid; grid-template-columns:1fr 1fr; gap:16px; align-items:start}
  @media (max-width: 720px){ .twoCols{ grid-template-columns: 1fr; } }
  .periodCol{display:flex; flex-direction:column; gap:10px}
  .periodCol.right{margin-left:10px;}
  .pRow{display:grid; grid-template-columns:100px 1fr; align-items:center; gap:6px;}
  .pRow label{font-size:13px; color:#333; white-space:nowrap; text-align:center;}

  .collapsibleHead{display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fafafa; margin-top:16px; width:fit-content; max-width:min(520px, 92%);}
  .chev{transition: transform .18s ease; width:14px; height:14px; display:inline-block}
  .collapsibleHead[aria-expanded="true"] .chev{ transform: rotate(90deg); }

  .folderRow{display:grid; grid-template-columns: 110px 1fr auto; gap:10px; align-items:center; margin:6px 0;}
  .folderRow > div:first-child{font-size:13px; color:#333; text-align:center;}
  .folderBadge{display:inline-flex; align-items:center; gap:8px; padding:4px 10px; border:1px solid #d1d5db; border-radius:999px; background:#f8fafc; font-size:12px}
  .folderBadge code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size:11px; color:#334155}
  .folderRow input.long{margin:4px 8px 4px 0;}
  .folderRow .btn{margin:4px 8px 4px 0;}

  .modal footer{padding:14px 16px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap}
  .field.periodNames > label{ margin-bottom:8px; display:block; }
  #skipRows .skipRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0; }

  .subjectLink{display:inline-block}
  .subjectLink .muted{border-bottom:1px dotted #d1d5db;}
  .subjectLink[data-clickable="true"]{cursor:pointer;}
  .subjectLink[data-clickable="true"]:hover .muted{color:#333}

  .inlineSearch{display:flex; gap:8px; align-items:center; padding:8px 12px; background:#fbfbfb; border-bottom:1px solid #efefef}
  .inlineSearch input{width:260px}
  .scopeTag{font-size:12px;color:#6b7280}

  /* --- Gist section --- */
  .gistWrap{margin-top:16px; border:1px dashed var(--border); border-radius:12px; padding:12px; background:#fafafa}
  .gistRow{display:grid; grid-template-columns:140px auto auto; gap:8px; align-items:center; margin:6px 0;}
  .gistRow label{text-align:center; font-size:13px;}
  .gistBadge{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid #cbd5e1; border-radius:999px; background:#f1f5f9; font-size:12px}
  #gistToken{ width:220px; } /* narrower token input */
  #gistId{ width:260px; }

  /* Make "Connect Gist" button fit its content */
  #gistSave{
    width:auto;
    inline-size:auto;
    max-width:fit-content;
    white-space:nowrap;
    padding:6px 10px;
    justify-self:start;
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 class="title-underline">Click Links to Access Weekly Agendas</h1>
    <button id="openSettings" class="iconBtn" title="Customize master template">
      <!-- Gear — Outline (8-teeth) -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/>
        <path d="M19 12a7 7 0 0 0-.08-.98l2.02-1.57-2-3.46-2.4.7a7 7 0 0 0-1.7-.99L14.5 3h-5l-.34 2.7a7 7 0 0 0-1.7.99l-2.4-.7-2 3.46 2.02 1.57A7 7 0 0 0 5 12c0 .33.03 .65.08 .98l-2.02 1.57 2 3.46 2.4-.7c.52 .41 1.1 .75 1.7 .99l.34 2.7h5l.34-2.7c.6-.24 1.18-.58 1.7-.99l2.4 .7 2-3.46-2.02-1.57c.05-.33 .08-.65 .08-.98Z"/>
      </svg>
      Settings
    </button>
  </header>

  <div class="toolbar">
    <button id="authBtn" class="btn" disabled>Loading Google…</button>
    <button id="signoutBtn" class="btn secondary" disabled>Sign out</button>
    <span id="authState" class="pill">Drive: <strong>signed out</strong></span>
    <span id="authError" class="pill err" style="display:none"></span>
  </div>

  <div id="currentWeekBlock"></div>
  <div class="sectionRule"></div>
  <div id="allWeeks"></div>

  <div id="emptyState" class="empty" style="display:none;">
    Configure in <strong>Settings</strong> to generate weekly agendas.
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="modal">
    <header>
      <h2 id="settingsTitle">Weekly Agenda Settings</h2>
      <button id="closeSettings" class="iconBtn" title="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6 6 18M6 6l12 12"/>
        </svg>
      </button>
    </header>
    <div class="body">
      <div class="topCols">
        <div class="fieldsForm">
          <div class="fRow">
            <label for="semesterSel">Semester</label>
            <select id="semesterSel">
              <option value="">— Select —</option>
              <option value="Spring">Spring</option>
              <option value="Fall">Fall</option>
            </select>
          </div>
          <div class="fRow">
            <label for="yearInput">Year</label>
            <input id="yearInput" type="number" min="2000" max="2100" step="1" />
          </div>
        </div>

        <div class="fieldsForm compact">
          <div class="fRow">
            <label for="firstMonday">First week</label>
            <input id="firstMonday" type="date" />
          </div>
          <div class="fRow">
            <label for="lastFriday">Last week</label>
            <input id="lastFriday" type="date" />
          </div>
        </div>
      </div>

      <div class="field" style="margin-top:6px;">
        <label>Weeks to skip (not counted)</label>
        <div id="skipRows"></div>
        <div class="row" style="margin-top:8px;">
          <button id="addSkip" class="btn secondary" type="button">+ Add skip week</button>
        </div>
      </div>

      <div class="field periodNames" style="margin-top:16px;">
        <label>Label each period (leave blank for conference)</label>
        <div class="twoCols" id="periodInputs"></div>
      </div>

      <div class="field" style="margin-top:16px;">
        <div id="folderToggle" class="collapsibleHead" role="button" tabindex="0" aria-expanded="false" aria-controls="folderChooserWrap">
          <span class="chev">▶</span>
          <span>Restrict each period to a Google Drive folder (optional)</span>
        </div>
        <div id="folderChooserWrap" style="display:none;">
          <div id="folderChooserArea" style="margin-top:10px;"></div>
        </div>
      </div>

      <!-- Gist connect section: ALWAYS VISIBLE -->
      <div id="gistBlock" class="gistWrap">
        <div class="gistRow">
          <label for="gistToken">GitHub Token</label>
          <input id="gistToken" type="password" />
          <button id="gistSave" class="btn" type="button">Connect Gist</button>
        </div>
        <div class="gistRow">
          <label for="gistId">Gist ID (optional)</label>
          <input id="gistId" type="text" />
          <div></div>
        </div>
        <div class="gistRow" id="gistStatusRow" style="display:none;">
          <label>Status</label>
          <div class="gistBadge" id="gistStatus">…</div>
          <div></div>
        </div>
      </div>
    </div>

    <footer>
      <div class="row">
        <button id="resetDefaults" class="btn secondary">Reset to Default</button>
      </div>
      <div class="row">
        <button id="saveSettings" class="btn" style="border-color:#10b981;background:#ecfdf5;color:#065f46">Save &amp; Generate</button>
      </div>
    </footer>
  </div>
</div>

<!-- Google APIs -->
<script src="https://apis.google.com/js/api.js" async defer></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
/* ===== Google config (includes AppData scope) ===== */
const GOOGLE = {
  API_KEY: "AIzaSyDWnOao76tK1ecBGfL21ZLxBDvChqlGrx0",
  CLIENT_ID: "462034083093-75pc8bgfieivcrkc6275vgahg44qhvvh.apps.googleusercontent.com",
  DISCOVERY_DOCS: [
    "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
    "https://slides.googleapis.com/$discovery/rest?version=v1"
  ],
  SCOPES:
    "https://www.googleapis.com/auth/drive.readonly " +
    "https://www.googleapis.com/auth/presentations.readonly " +
    "https://www.googleapis.com/auth/drive.appdata",
  authed: false,
};

/* ===== LocalStorage keys ===== */
const LS_KEY_LINKS   = "agenda_links_by_semester";
const LS_KEY_CFG     = "agenda_master_template_neutral_v1";
const LS_KEY_GH      = "agenda_github_sync_v1"; // {token, gistId}
const LS_KEY_AUTH    = "agenda_auth_meta_v1";

/* ===== Neutral defaults ===== */
const NEUTRAL_CFG = {
  semester:"", year:"",
  periods:["","","","","",""],
  periodFolders:["","","","","",""],
  periodFolderNames:["","","","","",""],
  firstMonday:"", lastFriday:"",
  skipWeeks:[],
  labelsFinalized:false
};

function saveAuthMeta(m){ localStorage.setItem(LS_KEY_AUTH, JSON.stringify(m||{})); }
function loadAuthMeta(){ try { return JSON.parse(localStorage.getItem(LS_KEY_AUTH)||"{}"); } catch { return {}; } }

/* ===== Utility dates ===== */
const dayMs = 24*60*60*1000;
function toDateAtMidnight(s){ if(!s) return null; const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d,0,0,0,0); }
function addDays(date,n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
function overlaps(aStart,aEnd,bStart,bEnd){ return !(aEnd < bStart || aStart > bEnd); }
function mondayOf(d){ const nd=new Date(d); const w=(nd.getDay()+6)%7; nd.setDate(nd.getDate()-w); nd.setHours(0,0,0,0); return nd; }
function fmtMonthLong(d){ return d.toLocaleDateString(undefined,{month:"long"}); }
function fmtDay(d){ return d.getDate(); }
function formatRangeFull(a,b){
  if(a.getMonth()===b.getMonth() && a.getFullYear()===b.getFullYear()){
    return `${fmtMonthLong(a)} ${fmtDay(a)}–${fmtDay(b)}`;
  } else {
    return `${fmtMonthLong(a)} ${fmtDay(a)}–${fmtMonthLong(b)} ${fmtDay(b)}`;
  }
}

/* ===== Config & links persistence ===== */
function loadCfg(){ const raw = localStorage.getItem(LS_KEY_CFG); if(!raw) return {...NEUTRAL_CFG};
  try{ const cfg = JSON.parse(raw);
    cfg.semester ??=""; cfg.year ??="";
    if(!Array.isArray(cfg.periods)||cfg.periods.length!==6) cfg.periods=["","","","","",""];
    if(!Array.isArray(cfg.periodFolders)||cfg.periodFolders.length!==6) cfg.periodFolders=["","","","","",""];
    if(!Array.isArray(cfg.periodFolderNames)||cfg.periodFolderNames.length!==6) cfg.periodFolderNames=["","","","","",""];
    cfg.firstMonday ??=""; cfg.lastFriday ??="";
    if(!Array.isArray(cfg.skipWeeks)) cfg.skipWeeks=[];
    cfg.labelsFinalized = !!cfg.labelsFinalized; return cfg;
  }catch{ return {...NEUTRAL_CFG}; }
}
function saveCfg(cfg){ localStorage.setItem(LS_KEY_CFG, JSON.stringify(cfg)); }
function keyForLinks(cfg){ return `${cfg.semester || "Semester"}-${cfg.year || "Year"}`; }
function loadLinksFor(cfg){ try{ const all = JSON.parse(localStorage.getItem(LS_KEY_LINKS) || "{}"); return all[keyForLinks(cfg)] || {}; }catch{ return {}; } }
function saveLinksFor(cfg, linksObj){
  let all = {}; try{ all = JSON.parse(localStorage.getItem(LS_KEY_LINKS) || "{}"); }catch{}
  all[keyForLinks(cfg)] = linksObj;
  localStorage.setItem(LS_KEY_LINKS, JSON.stringify(all));
}

/* ===== Google auth loader ===== */
let tokenClient = null; let gapiReady = false; let gisReady = false; let refreshTimer = null;

function setAuthUiState({enabled, text, error}){
  const authBtn = document.getElementById("authBtn");
  const errEl = document.getElementById("authError");
  if (typeof enabled === "boolean") authBtn.disabled = !enabled;
  if (text) authBtn.textContent = text;
  if (error){ errEl.style.display="inline-block"; errEl.textContent = error; } else { errEl.style.display="none"; errEl.textContent=""; }
}
async function loadGapiClient(){
  if (gapiReady) return;
  await new Promise((resolve,reject)=>{
    let waited = 0;
    const tick = () => {
      if (window.gapi && window.gapi.load) {
        window.gapi.load('client', async ()=>{
          try{
            await window.gapi.client.init({ apiKey: GOOGLE.API_KEY, discoveryDocs: GOOGLE.DISCOVERY_DOCS });
            gapiReady = true; resolve();
          }catch(e){ reject(e); }
        });
      } else {
        waited += 50;
        if (waited > 10000) return reject(new Error("Google API client failed to load"));
        setTimeout(tick,50);
      }
    };
    tick();
  });
}
async function loadGis(){
  if (gisReady) return;
  await new Promise((resolve,reject)=>{
    let waited = 0;
    const tick = () => {
      if (window.google && window.google.accounts && window.google.accounts.oauth2) {
        gisReady = true; resolve();
      } else {
        waited += 50;
        if (waited > 10000) return reject(new Error("Google Identity Services failed to load"));
        setTimeout(tick,50);
      }
    };
    tick();
  });
}
async function initAuth(){
  await loadGapiClient();
  await loadGis();
  if (tokenClient) return tokenClient;
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE.CLIENT_ID,
    scope: GOOGLE.SCOPES,
    callback: async (resp) => {
      if (resp && resp.error) { setAuthUiState({error: resp.error_description || resp.error}); return; }
      if (!resp || !resp.access_token) return;

      gapi.client.setToken({ access_token: resp.access_token });
      GOOGLE.authed = true;
      try {
        const about = await gapi.client.drive.about.get({ fields: "user(emailAddress)" });
        const emailHint = about?.result?.user?.emailAddress || "";
        const prev = loadAuthMeta();
        saveAuthMeta({ email: emailHint || prev.email || "", granted: true });
      } catch(e){
        const prev = loadAuthMeta();
        saveAuthMeta({ email: prev.email || "", granted: true });
      }
      updateAuthUi();
    }
  });
  return tokenClient;
}
async function trySilentSignIn(){
  try{
    await initAuth();
    const meta = loadAuthMeta();
    tokenClient.requestAccessToken({ prompt:"", login_hint: meta.email || undefined });
    return await new Promise(resolve=>{
      const start=Date.now();
      const check=()=>{ const tok=gapi.client.getToken?.(); if(tok && tok.access_token) return resolve(true);
        if(Date.now()-start>1500) return resolve(false); setTimeout(check,50); };
      check();
    });
  }catch(e){ console.warn("Silent sign-in failed:", e); return false; }
}
async function ensureSignedIn(){
  try{
    await initAuth();
    const existing = gapi.client.getToken?.();
    if (existing && existing.access_token){
      GOOGLE.authed = true; updateAuthUi(); return true;
    }
    const meta = loadAuthMeta();
    tokenClient.requestAccessToken({ prompt: "consent", login_hint: meta.email || undefined });
    return true;
  }catch(e){
    const msg = String(e && (e.error_description || e.message || e)).toLowerCase();
    if (msg.includes("origin") || msg.includes("authorized javascript origins")){
      setAuthUiState({error:"Origin not allowed — add this site to Authorized JavaScript origins in Google Cloud."});
    } else {
      setAuthUiState({error:"Sign-in failed. " + (e.error_description || e.message || e)});
    }
    return false;
  }
}
async function signOut(){
  try{
    const tok = gapi.client.getToken?.();
    if (tok && tok.access_token) {
      try{ google.accounts.oauth2.revoke(tok.access_token); }catch(e){}
    }
  } finally {
    gapi.client.setToken(null); GOOGLE.authed=false;
    const meta=loadAuthMeta(); saveAuthMeta({ email: meta.email || "", granted:false }); updateAuthUi();
  }
}
function scheduleSilentRefresh(){
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(async ()=>{
    const meta = loadAuthMeta(); if(!meta.granted) return;
    const ok = await trySilentSignIn(); if(ok){ GOOGLE.authed=true; updateAuthUi(); }
  }, 45*60*1000);
}
function updateAuthUi(){
  const meta = loadAuthMeta();
  const email = (meta && meta.email) ? meta.email : "";
  const authBtn = document.getElementById("authBtn");
  authBtn.textContent = (GOOGLE.authed && email) ? email : (gisReady && gapiReady ? "Connect Google Drive" : "Loading Google…");
  document.getElementById("authState").innerHTML = "Drive: <strong>"+(GOOGLE.authed?"signed in":"signed out")+"</strong>";
  document.getElementById("signoutBtn").disabled = !GOOGLE.authed;
  setAuthUiState({enabled: gisReady && gapiReady, text: authBtn.textContent});
}

/* ===== Drive/Slides helpers ===== */
async function searchSlides(hint, folderId){
  await ensureSignedIn();
  const clauses = [
    "mimeType='application/vnd.google-apps.presentation'",
    "trashed=false",
    hint ? `name contains '${hint.replace(/'/g,"\\'")}'` : null,
    folderId ? `'${folderId}' in parents` : null
  ].filter(Boolean);
  const q = clauses.join(" and ");
  const res = await gapi.client.drive.files.list({
    q, pageSize: 20, orderBy: "modifiedTime desc",
    fields: "files(id,name,modifiedTime,webViewLink)"
  });
  return res.result.files || [];
}
async function searchFolders(term){
  await ensureSignedIn();
  const q = ["mimeType='application/vnd.google-apps.folder'","trashed=false", term?`name contains '${term.replace(/'/g,"\\'")}'`:null].filter(Boolean).join(" and ");
  const res = await gapi.client.drive.files.list({ q, pageSize: 10, fields: "files(id,name)" });
  return res.result.files || [];
}
function slideLink(fileId, pageObjectId){ return `https://docs.google.com/presentation/d/${fileId}/edit#slide=id.${pageObjectId}`; }
function titleFromSlide(slide, index){
  const elems = slide.pageElements || [];
  for(const el of elems){
    const shape = el.shape; if(!shape) continue;
    const ph = shape.placeholder;
    if(ph && ph.type==="TITLE" && shape.text && shape.text.textElements){
      let s=""; for(const te of shape.text.textElements){ if(te.textRun && te.textRun.content) s+=te.textRun.content; }
      s=(s||"").trim(); if(s) return s;
    }
  }
  return `Slide ${index+1}`;
}
async function getSlideThumb(presentationId, pageObjectId){
  try{
    const r=await gapi.client.slides.presentations.pages.getThumbnail({
      presentationId, pageObjectId,
      "thumbnailProperties.mimeType":"PNG","thumbnailProperties.thumbnailSize":"MEDIUM"
    });
    return r.result.contentUrl;
  }catch(e){
    try{
      const r2=await gapi.client.slides.presentations.pages.getThumbnail({
        presentationId, pageObjectId,
        "thumbnailProperties.mimeType":"PNG","thumbnailProperties.thumbnailSize":"SMALL"
      });
      return r2.result.contentUrl;
    }catch{ return ""; }
  }
}
async function fetchFolderNameById(id){
  if(!id) return "";
  try{
    await ensureSignedIn();
    const r = await gapi.client.drive.files.get({ fileId:id, fields:"id,name" });
    return r?.result?.name || "";
  }catch{ return ""; }
}

/* ===== Cloud Sync (Drive AppData) ===== */
const SYNC_FILE_NAME = "weekly-agenda-sync.json";
function buildSyncPayload(){
  const cfg = loadCfg();
  let allLinks = {};
  try { allLinks = JSON.parse(localStorage.getItem(LS_KEY_LINKS) || "{}"); } catch {}
  return { cfg, linksBySemester: allLinks, updatedAt: new Date().toISOString() };
}
function applyCloudPayload(payload){
  if (!payload || typeof payload !== "object") return;
  if (payload.cfg) saveCfg(payload.cfg);
  if (payload.linksBySemester) localStorage.setItem(LS_KEY_LINKS, JSON.stringify(payload.linksBySemester));
}
async function getOrCreateAppDataFileId(createIfMissing=false){
  await ensureSignedIn();
  const list = await gapi.client.drive.files.list({
    spaces: "appDataFolder",
    q: `name='${SYNC_FILE_NAME}' and trashed=false`,
    fields: "files(id,name)"
  });
  const found = (list

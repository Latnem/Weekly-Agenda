<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weekly Agendas — Master Template (GIS + Silent Auth + Remember Email)</title>
<style>
  :root{ --ink:#111; --muted:#666; --link:#2166c2; --ring:#1697BB; --bg:#fff; --border:#e5e7eb; }
  html,body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--ink); background:#fff; margin:0}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px; position:relative}
  header{display:flex;align-items:center;justify-content:space-between;gap:24px;margin-bottom:16px}
  h1{font-weight:700; letter-spacing:.2px; margin:0; white-space: nowrap}
  .iconBtn{border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; margin-left:16px;}
  .iconBtn svg{width:18px;height:18px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 18px}
  .btn{border:1px solid var(--ring); color:#084b5a; padding:8px 12px; border-radius:10px; background:#e9f6fb; cursor:pointer; font-weight:600}
  .btn.secondary{border-color:#ddd;background:#fafafa;color:#222}
  .btn.ghost{border:1px dashed var(--border); background:#fff; color:#333}
  .btn.warn{border-color:#f59e0b;background:#fff7ed;color:#8a4b00}
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .pill{font-size:12px; border:1px solid #ddd; padding:2px 8px; border-radius:999px; color:#333; background:#fafafa}

  .empty{padding:20px 24px; border:1px dashed var(--border); border-radius:12px; color:#555; background:#fafafa; white-space:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; width:fit-content; max-width:min(90vw, 620px); display:block; margin:8px 0; box-sizing:border-box; text-align:left;}

  .sectionRule{ height:2px; background:#d1d5db; width:min(420px, 90%); margin:18px auto 6px; border-radius:2px; }

  .grid{border:2px solid #000; border-collapse:collapse; width:100%}
  .grid th,.grid td{border:1px solid #000; padding:10px 12px; vertical-align:top}
  .grid th{font-weight:700; text-align:left; background:#fafafa}
  .sub{font-size:12px;color:#444;margin-top:2px}
  .note{font-size:13px;color:#444;line-height:1.35}
  .weekHdr{display:flex; align-items:baseline; gap:12px; margin:28px 0 8px}
  .wkTitle{font-weight:800; font-size:18px}
  .wkLabel{font-weight:400; font-size:16px; white-space:nowrap}

  .badge{ border:1px solid transparent; background:#eee; color:#111; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; }
  .badge--current{  border-color:#0a7e2a33; background:#e8f8ed; color:#0f5c26; }
  .badge--upcoming{ border-color:#1d4ed833; background:#e6f0ff; color:#1d4ed8; }
  .badge--past{     border-color:#b91c1c33; background:#ffecec; color:#b91c1c; }

  .link{color:var(--link); text-decoration:underline; cursor:pointer}
  .cellActions{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}

  input[type="search"], input[type="text"], select, input[type="number"], input[type="date"]{
    border:1px solid #ccc; border-radius:10px; padding:8px 10px; width:140px; min-width:120px; outline:none; background:#fff;
  }
  input.long{width:260px}
  input.full{width:100%}
  input::placeholder{ color:#888; }
  input:focus, select:focus{border-color:var(--ring); box-shadow:0 0 0 3px #1697bb33}

  .results{margin-top:8px; border:1px solid #e5e5e5; border-radius:10px; overflow:hidden}
  .resultItem{padding:10px 12px; border-top:1px solid #efefef; display:flex; justify-content:space-between; align-items:center; gap:12px}
  .resultItem:first-child{border-top:none}
  .resultItem small{color:#666}
  .colNotes{width:220px}
  .muted{color:#666}
  .time{font-weight:700}

  .slidesList{border-top:1px solid #eee; margin-top:8px; padding-top:8px}
  .slideRow{display:grid; grid-template-columns: 140px 1fr auto; align-items:center; gap:12px; padding:8px 0; border-top:1px dashed #eee}
  .slideRow:first-child{border-top:none}
  .thumb{ width:140px; height:79px; border:1px solid #e5e7eb; border-radius:8px; object-fit:cover; background:#f3f4f6; }
  .thumb.skel{ animation: pulse 1.2s ease-in-out infinite; filter: saturate(.2) blur(.2px); }
  @keyframes pulse { 0%{opacity:.65} 50%{opacity:1} 100%{opacity:.65} }
  .slideTitle{font-size:13px; color:#333}
  .slideMeta{font-size:12px; color:#777}
  .choose{padding:8px 12px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; cursor:pointer}
  .choose:disabled{opacity:.6; cursor:not-allowed}

  .modalBackdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50;}
  .modal{ width:min(980px,92vw); background:#fff; border-radius:16px; border:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,.15); }
  .modal header{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center}
  .modal h2{margin:0; font-size:18px}
  .modal .body{padding:16px}
  .fields{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .field{display:flex; flex-direction:column; gap:6px}
  .field label{font-size:13px; color:#333}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}

  /* NEW: two-column period labels */
  .twoCols{display:grid; grid-template-columns:1fr 1fr; gap:16px; align-items:start}
  .periodCol{display:flex; flex-direction:column; gap:10px}
  .pRow{display:grid; grid-template-columns:90px 1fr; align-items:center; gap:8px}
  .pRow label{font-size:13px; color:#333}

  .folderRow{display:grid; grid-template-columns: 100px 1fr auto; gap:10px; align-items:center}
  .folderBadge{display:inline-flex; align-items:center; gap:8px; padding:4px 10px; border:1px solid #d1d5db; border-radius:999px; background:#f8fafc; font-size:12px}
  .folderBadge code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; font-size:11px; color:#334155}
  .modal footer{padding:14px 16px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Click Links to Access Weekly Agendas</h1>
    <button id="openSettings" class="iconBtn" title="Customize master template">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 3.2 17l.06-.06A1.65 1.65 0 0 0 3.59 15a1.65 1.65 0 0 0-1.51-1H2a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 6.04 2.2l.06.06A1.65 1.65 0 0 0 7.92 2h.18A1.65 1.65 0 0 0 9.6 3.59 1.65 1.65 0 0 0 11 5.1V5a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06A2 2 0 1 1 21.8 6.04l-.06.06A1.65 1.65 0 0 0 21.41 7.9 1.65 1.65 0 0 0 23 9.6v.18A1.65 1.65 0 0 0 21.41 11H21a1.65 1.65 0 0 0-1.6 2Z"/>
      </svg>
      Settings
    </button>
  </header>

  <div class="toolbar">
    <button id="authBtn" class="btn">Connect Google Drive</button>
    <button id="signoutBtn" class="btn secondary" disabled>Sign out</button>
    <span id="authState" class="pill">Drive: <strong>signed out</strong></span>
  </div>

  <div id="currentWeekBlock"></div>
  <div class="sectionRule"></div>
  <div id="allWeeks"></div>

  <div id="emptyState" class="empty" style="display:none;">
    Configure in <strong>Settings</strong> to generate weekly agendas.
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="modal">
    <header>
      <h2 id="settingsTitle">Weekly Agenda Settings</h2>
      <button id="closeSettings" class="iconBtn" title="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6 6 18M6 6l12 12"/>
        </svg>
      </button>
    </header>
    <div class="body">
      <div class="fields">
        <div class="field">
          <label for="semesterSel">Semester</label>
          <select id="semesterSel">
            <option value="">— Select —</option>
            <option value="Spring">Spring</option>
            <option value="Fall">Fall</option>
          </select>
        </div>
        <div class="field">
          <label for="yearInput">Year</label>
          <input id="yearInput" type="number" min="2000" max="2100" step="1" placeholder="" />
        </div>
        <div class="field">
          <label for="firstMonday">First week</label>
          <input id="firstMonday" type="date" />
        </div>
        <div class="field">
          <label for="lastFriday">Last week</label>
          <input id="lastFriday" type="date" />
        </div>
      </div>

      <!-- Period names -->
      <div class="field" style="margin-top:12px;">
        <label>Label each period (leave blank for conference)</label>
        <div class="twoCols" id="periodInputs"></div>
      </div>

      <!-- Folder chooser per period -->
      <div class="field" style="margin-top:16px;">
        <label>Restrict each period to a Google Drive folder (optional)</label>
        <div id="folderChooserArea"></div>
      </div>

      <div class="field" style="margin-top:16px;">
        <label>Weeks to skip (not counted)</label>
        <div id="skipRows"></div>
        <div class="row" style="margin-top:8px;">
          <button id="addSkip" class="btn ghost" type="button">+ Add skip week</button>
        </div>
      </div>
    </div>

    <footer>
      <div class="row">
        <button id="resetDefaults" class="btn secondary">Reset to Default</button>
        <button id="saveBaseline" class="btn warn">Save as Baseline</button>
        <button id="loadBaseline" class="btn secondary">Load Baseline</button>
      </div>
      <div class="row" style="gap:8px; flex-wrap:wrap">
        <input id="ghToken" type="password" placeholder="GitHub Token (gist scope)" style="width:260px" />
        <input id="ghGistId" type="text" placeholder="Gist ID (auto after first save)" style="width:260px" />
        <button id="gistSave" class="btn">Save to Gist</button>
        <button id="gistLoad" class="btn secondary">Load from Gist</button>
      </div>
      <div class="row">
        <button id="saveSettings" class="btn">Save & Regenerate</button>
      </div>
    </footer>
  </div>
</div>

<!-- Google APIs -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
/* ===== Google config (your keys) ===== */
const GOOGLE = {
  API_KEY: "AIzaSyDWnOao76tK1ecBGfL21ZLxBDvChqlGrx0",
  CLIENT_ID: "462034083093-75pc8bgfieivcrkc6275vgahg44qhvvh.apps.googleusercontent.com",
  DISCOVERY_DOCS: [
    "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
    "https://slides.googleapis.com/$discovery/rest?version=v1"
  ],
  SCOPES: "https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/presentations.readonly",
  authed: false,
};

/* ===== LocalStorage keys & defaults ===== */
const LS_KEY_LINKS   = "agenda_links_by_semester";
const LS_KEY_CFG     = "agenda_master_template_neutral_v1";
const LS_KEY_BASELINE= "agenda_master_baseline_v1";
const LS_KEY_GH      = "agenda_github_sync_v1";
const LS_KEY_AUTH    = "agenda_auth_meta_v1"; // { email?: string, granted: boolean }

const NEUTRAL_CFG = {
  semester: "",
  year: "",
  periods: ["","","","","",""],
  periodFolders: ["","","","","",""], // folder IDs per period
  firstMonday: "",
  lastFriday: "",
  skipWeeks: [],
  labelsFinalized: false
};

/* ===== Auth metadata helpers ===== */
function saveAuthMeta(m){ localStorage.setItem(LS_KEY_AUTH, JSON.stringify(m||{})); }
function loadAuthMeta(){ try { return JSON.parse(localStorage.getItem(LS_KEY_AUTH)||"{}"); } catch { return {}; } }

/* ===== Date helpers ===== */
const dayMs = 24*60*60*1000;
function toDateAtMidnight(s){ if(!s) return null; const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d,0,0,0,0); }
function addDays(date,n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
function overlaps(aStart,aEnd,bStart,bEnd){ return !(aEnd < bStart || aStart > bEnd); }
function mondayOf(d){ const nd=new Date(d); const w=(nd.getDay()+6)%7; nd.setDate(nd.getDate()-w); nd.setHours(0,0,0,0); return nd; }
function fmtMonthLong(d){ return d.toLocaleDateString(undefined,{month:"long"}); }
function fmtDay(d){ return d.getDate(); }
function formatRangeFull(a,b){
  if(a.getMonth()===b.getMonth() && a.getFullYear()===b.getFullYear()){
    return `${fmtMonthLong(a)} ${fmtDay(a)}–${fmtDay(b)}`;
  } else {
    return `${fmtMonthLong(a)} ${fmtDay(a)}–${fmtMonthLong(b)} ${fmtDay(b)}`;
  }
}

/* ===== Config persistence ===== */
function saveBaselineCfg(cfg){ localStorage.setItem(LS_KEY_BASELINE, JSON.stringify(cfg)); }
function loadBaselineCfg(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_BASELINE) || "null"); }catch{ return null; } }
function loadCfg(){ const raw = localStorage.getItem(LS_KEY_CFG); if(!raw) return {...NEUTRAL_CFG};
  try{ const cfg = JSON.parse(raw);
    cfg.semester ??=""; cfg.year ??="";
    if(!Array.isArray(cfg.periods)||cfg.periods.length!==6) cfg.periods=["","","","","",""];
    if(!Array.isArray(cfg.periodFolders)||cfg.periodFolders.length!==6) cfg.periodFolders=["","","","","",""];
    cfg.firstMonday ??=""; cfg.lastFriday ??="";
    if(!Array.isArray(cfg.skipWeeks)) cfg.skipWeeks=[];
    cfg.labelsFinalized = !!cfg.labelsFinalized; return cfg;
  }catch{ return {...NEUTRAL_CFG}; }
}
function saveCfg(cfg){ localStorage.setItem(LS_KEY_CFG, JSON.stringify(cfg)); }
function keyForLinks(cfg){ return `${cfg.semester || "Semester"}-${cfg.year || "Year"}`; }
function loadLinksFor(cfg){ try{ const all = JSON.parse(localStorage.getItem(LS_KEY_LINKS) || "{}"); return all[keyForLinks(cfg)] || {}; }catch{ return {}; } }
function saveLinksFor(cfg, linksObj){
  let all = {}; try{ all = JSON.parse(localStorage.getItem(LS_KEY_LINKS) || "{}"); }catch{}
  all[keyForLinks(cfg)] = linksObj;
  localStorage.setItem(LS_KEY_LINKS, JSON.stringify(all));
}

/* ===== Build Mon–Fri weeks ===== */
function buildWeeks(cfg){
  const startRaw = toDateAtMidnight(cfg.firstMonday);
  const endRaw   = toDateAtMidnight(cfg.lastFriday);
  if(!startRaw || !endRaw || startRaw > endRaw) return [];
  const startMon = mondayOf(startRaw);
  const endFri   = addDays(mondayOf(endRaw), 4);
  const skipRanges = (cfg.skipWeeks||[]).map(({from,to})=>{
    const sRaw = toDateAtMidnight(from); const eRaw = toDateAtMidnight(to);
    if(!sRaw || !eRaw) return null;
    const s = mondayOf(sRaw); const e = addDays(mondayOf(eRaw), 4);
    return {from:s, to:e};
  }).filter(Boolean);

  const weeks=[]; let weekNum=0;
  for(let mon=new Date(startMon); mon <= endFri; mon = addDays(mon,7)){
    const fri = addDays(mon,4);
    const isSkipped = skipRanges.some(r => overlaps(mon, fri, r.from, r.to));
    if(isSkipped) continue;
    weekNum++; weeks.push({ n:weekNum, monday:new Date(mon), friday:new Date(fri) });
  }
  return weeks;
}

/* ===== Choose current week (auto-advance Sat 00:00) ===== */
function chooseDisplayWeek(weeks, now=new Date()){
  if(!weeks.length) return { week:null, idx:-1 };
  const mon = mondayOf(now);
  let idx = weeks.findIndex(w => +w.monday === +mon);
  if(idx !== -1){
    const friMidnight = new Date(weeks[idx].friday); friMidnight.setHours(0,0,0,0);
    const satMidnight = new Date(friMidnight.getTime() + dayMs);
    if (now >= satMidnight) idx = Math.min(idx + 1, weeks.length - 1);
  } else { idx = (now < weeks[0].monday) ? 0 : (weeks.length - 1); }
  return { week: weeks[idx], idx };
}

/* ===== Google APIs: gapi client + GIS token (silent reauth + remember email) ===== */
let tokenClient = null;
let gapiReady = false;
let refreshTimer = null;

function updateAuthUi(){
  document.getElementById("authState").innerHTML =
    "Drive: <strong>"+(GOOGLE.authed?"signed in":"signed out")+"</strong>";
  document.getElementById("signoutBtn").disabled = !GOOGLE.authed;
}

async function loadGapiClient(){
  if (gapiReady) return;
  await new Promise(r => gapi.load("client", r));
  await gapi.client.init({ apiKey: GOOGLE.API_KEY, discoveryDocs: GOOGLE.DISCOVERY_DOCS });
  gapiReady = true;
}

async function initAuth(){
  await loadGapiClient();
  if (tokenClient) return tokenClient;
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE.CLIENT_ID,
    scope: GOOGLE.SCOPES,
    callback: async (resp) => {
      if (resp && resp.error) {
        console.error("GIS token error:", resp);
        alert("Sign-in failed: " + (resp.error_description || resp.error));
        return;
      }
      // Token acquired
      gapi.client.setToken({ access_token: resp.access_token });
      GOOGLE.authed = true; updateAuthUi();

      // Always remember account email for future login_hint
      try {
        const about = await gapi.client.drive.about.get({ fields: "user(emailAddress)" });
        const emailHint = about?.result?.user?.emailAddress || "";
        saveAuthMeta({ email: emailHint, granted: true });
      } catch(e){
        const prev = loadAuthMeta();
        saveAuthMeta({ email: prev.email || "", granted: true });
      }
    }
  });
  return tokenClient;
}

/* Try silent sign-in (no popup). Returns true if token present. */
async function trySilentSignIn(){
  await initAuth();
  const meta = loadAuthMeta();
  try {
    tokenClient.requestAccessToken({
      prompt: "",                           // silent mode
      login_hint: meta.email || undefined,  // stick to same account if known
    });
    // Wait briefly to see if token was set by callback
    return await new Promise(resolve => {
      const start = Date.now();
      const check = () => {
        const tok = gapi.client.getToken?.();
        if (tok && tok.access_token) return resolve(true);
        if (Date.now() - start > 1500) return resolve(false);
        setTimeout(check, 50);
      };
      check();
    });
  } catch(e) {
    return false;
  }
}

/* Interactive sign-in (opens popup if needed) */
async function ensureSignedIn(){
  if (!window.google || !window.gapi) { alert("Google libraries not loaded yet. Try again in a second."); return; }
  await initAuth();

  const tok = gapi.client.getToken?.();
  if (tok && tok.access_token) { GOOGLE.authed = true; updateAuthUi(); return true; }

  const meta = loadAuthMeta();
  tokenClient.requestAccessToken({
    prompt: "consent",
    login_hint: meta.email || undefined,
  });
  return true;
}

/* Sign out: revoke local token and clear granted flag (keep or wipe email – here we keep it) */
async function signOut(){
  const tok = gapi.client.getToken?.();
  if (tok && tok.access_token) {
    try { google.accounts.oauth2.revoke(tok.access_token); } catch(e){}
  }
  gapi.client.setToken(null);
  GOOGLE.authed = false; updateAuthUi();
  const meta = loadAuthMeta();
  // keep email for next time; just mark not granted so we won't try silent until they connect again
  saveAuthMeta({ email: meta.email || "", granted: false });
}

/* Background silent refresh every 45 minutes */
function scheduleSilentRefresh(){
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(async ()=>{
    const meta = loadAuthMeta();
    if (!meta.granted) return;
    const ok = await trySilentSignIn();
    if (ok) { GOOGLE.authed = true; updateAuthUi(); }
  }, 45 * 60 * 1000);
}

/* ===== Drive search + Slides helpers ===== */
async function searchSlides(hint, folderId){
  await ensureSignedIn();
  const clauses = [
    "mimeType='application/vnd.google-apps.presentation'",
    "trashed=false",
    hint ? `name contains '${hint.replace(/'/g,"\\'")}'` : null,
    folderId ? `'${folderId}' in parents` : null
  ].filter(Boolean);
  const q = clauses.join(" and ");
  const res = await gapi.client.drive.files.list({
    q, pageSize: 10, fields: "files(id,name,modifiedTime,webViewLink)"
  });
  return res.result.files || [];
}
async function searchFolders(term){
  await ensureSignedIn();
  const q = [
    "mimeType='application/vnd.google-apps.folder'",
    "trashed=false",
    term ? `name contains '${term.replace(/'/g,"\\'")}'` : null
  ].filter(Boolean).join(" and ");
  const res = await gapi.client.drive.files.list({
    q, pageSize: 10, fields: "files(id,name)"
  });
  return res.result.files || [];
}
function slideLink(fileId, pageObjectId){
  return `https://docs.google.com/presentation/d/${fileId}/edit#slide=id.${pageObjectId}`;
}
function titleFromSlide(slide, index){
  const elems = slide.pageElements || [];
  for(const el of elems){
    const shape = el.shape; if(!shape) continue;
    const ph = shape.placeholder;
    if(ph && ph.type === "TITLE" && shape.text && shape.text.textElements){
      let s = "";
      for(const te of shape.text.textElements){ if(te.textRun && te.textRun.content) s += te.textRun.content; }
      s = (s || "").trim(); if(s) return s;
    }
  }
  return `Slide ${index+1}`;
}
async function getSlideThumb(presentationId, pageObjectId){
  try{
    const res = await gapi.client.slides.presentations.pages.getThumbnail({
      presentationId, pageObjectId,
      "thumbnailProperties.mimeType":"PNG", "thumbnailProperties.thumbnailSize":"MEDIUM"
    });
    return res.result.contentUrl;
  }catch(e){
    try{
      const res2 = await gapi.client.slides.presentations.pages.getThumbnail({
        presentationId, pageObjectId,
        "thumbnailProperties.mimeType":"PNG", "thumbnailProperties.thumbnailSize":"SMALL"
      });
      return res2.result.contentUrl;
    }catch{ return ""; }
  }
}

/* ===== Labels ===== */
function weekActualLabel(w){ return formatRangeFull(w.monday, w.friday); }
function headerActualLabel(cfg){ return `${cfg.semester || "Semester"} ${cfg.year || "Year"}`; }

/* ===== Render one week ===== */
function renderWeekTable(cfg, w, links){
  const table = document.createElement("table"); table.className="grid";
  const thead = document.createElement("thead"); const trh = document.createElement("tr");

  const t0 = document.createElement("th"); t0.textContent = headerActualLabel(cfg); trh.appendChild(t0);
  const PERIOD_TIMES = [
    { title:"8:30-9:26",  sub:"8:30-9:12" },
    { title:"9:33-10:29", sub:"9:19-10:01" },
    { title:"10:46-11:42",sub:"10:55-11:37" },
    { title:"11:49-12:57",sub:"11:44-12:26" },
    { title:"1:34-2:30",  sub:"1:03-1:45" },
    { title:"2:37-3:33",  sub:"1:52-2:34" },
  ];
  PERIOD_TIMES.forEach(p=>{
    const th=document.createElement("th");
    th.innerHTML = `<div class="time">${p.title}</div><div class="sub">${p.sub}</div>`;
    trh.appendChild(th);
  });
  const thNotes=document.createElement("th"); thNotes.textContent="Notes:"; thNotes.className="colNotes"; trh.appendChild(thNotes);
  thead.appendChild(trh); table.appendChild(thead);

  const tbody = document.createElement("tbody"); const tr = document.createElement("tr");
  const label = document.createElement("td"); label.innerHTML = `<div class="wkLabel">Week ${w.n}</div>`; tr.appendChild(label);

  cfg.periods.forEach((periodLabel,idx)=>{
    const td=document.createElement("td");
    const saved = links?.[w.n]?.[idx];

    if(!periodLabel){ td.innerHTML = `<div class="muted">Conference</div>`; tr.appendChild(td); return; }

    if(saved){
      const href = saved.slideId ? slideLink(saved.id, saved.slideId) : (saved.url || "#");
      td.innerHTML = `<div><a class="link" href="${href}" target="_blank" rel="noopener">${periodLabel}</a></div>`;
    }else{
      td.innerHTML = `<div class="muted">${periodLabel}</div>`;
    }

    const box = document.createElement("div"); box.className="cellActions";
    const search = document.createElement("input"); search.type="search"; search.placeholder = `${periodLabel}`; search.value = "";
    const attachBtn = document.createElement("button"); attachBtn.className="btn"; attachBtn.textContent="Link";
    const results = document.createElement("div"); results.className="results"; results.style.display="none";

    attachBtn.addEventListener("click", async ()=>{
      results.style.display="block"; results.innerHTML = `<div class="resultItem"><em>Searching…</em></div>`;
      try{
        const hintRaw = (search.value.trim() || search.placeholder || `Week ${w.n}`);
        const folderId = (loadCfg().periodFolders || [])[idx] || "";
        const files = await searchSlides(hintRaw, folderId);
        if(!files.length){ results.innerHTML = `<div class="resultItem"><em>No matches found.</em></div>`; return; }
        results.innerHTML = "";
        files.forEach((f)=>{
          const row = document.createElement("div"); row.className="resultItem";
          const left = document.createElement("div");
          left.innerHTML = `<div><strong>${f.name}</strong></div><small>Last modified ${new Date(f.modifiedTime).toLocaleDateString()}</small>`;
          const pick = document.createElement("button"); pick.className="btn"; pick.textContent="Select";
          row.appendChild(left); row.appendChild(pick); results.appendChild(row);

          pick.addEventListener("click", async ()=>{
            pick.disabled = true; pick.textContent = "Loading slides…";
            try{
              const pres = await gapi.client.slides.presentations.get({ presentationId: f.id });
              const slides = pres.result.slides || [];
              const nested = document.createElement("div"); nested.className = "slidesList";
              if(!slides.length){
                nested.innerHTML = `<div class="slideRow"><span class="slideTitle">No slides found</span></div>`;
              } else {
                slides.forEach((s, i)=>{
                  const sr = document.createElement("div"); sr.className = "slideRow";
                  const img = document.createElement("img"); img.className="thumb skel"; img.alt="Slide thumbnail"; img.loading="lazy";
                  const meta = document.createElement("div");
                  const human = titleFromSlide(s, i);
                  meta.innerHTML = `<div class="slideTitle">${human}</div><div class="slideMeta">#${i+1}</div>`;
                  const chooseBtn = document.createElement("button"); chooseBtn.className="choose"; chooseBtn.textContent="Choose";
                  chooseBtn.addEventListener("click", ()=>{
                    const all=loadLinksFor(cfg); all[w.n]??={};
                    all[w.n][idx] = { id: f.id, name: f.name, slideId: s.objectId, url: f.webViewLink };
                    saveLinksFor(cfg, all);
                    td.querySelector(".muted")?.remove(); td.querySelector("div")?.remove();
                    const linkDiv=document.createElement("div");
                    linkDiv.innerHTML = `<a class="link" href="${slideLink(f.id, s.objectId)}" target="_blank" rel="noopener">${periodLabel}</a>`;
                    td.insertBefore(linkDiv, box); results.style.display="none";
                  });

                  sr.appendChild(img); sr.appendChild(meta); sr.appendChild(chooseBtn); nested.appendChild(sr);
                  (async ()=>{ const url = await getSlideThumb(f.id, s.objectId);
                    if(url){ img.src = url; img.classList.remove("skel"); }
                  })();
                });
              }
              row.insertAdjacentElement("afterend", nested);
              pick.textContent = "Slides loaded";
              setTimeout(()=>{ pick.textContent="Select"; pick.disabled=false; }, 800);
            }catch(e){
              pick.textContent = "Select"; pick.disabled = false;
              alert("Failed to load slides: " + (e.result?.error?.message || e.message || e));
            }
          });
        });
      }catch(err){
        results.innerHTML = `<div class="resultItem"><em>Error: ${err.message||err}</em></div>`;
      }
    });

    box.appendChild(search); box.appendChild(attachBtn);
    td.appendChild(box); td.appendChild(results); tr.appendChild(td);
  });

  const tNotes=document.createElement("td");
  tNotes.innerHTML = `<div class="note">*Agendas<br>*Lessons<br>*Grades<br>*e-Calendar<br>*Announcements<br>*Services</div>`;
  tr.appendChild(tNotes);

  tbody.appendChild(tr); table.appendChild(tbody);
  return table;
}

/* ===== Render entire page ===== */
function renderAll(){
  const cfg = loadCfg(); const links = loadLinksFor(cfg);
  const hasConfig = !!cfg.semester && !!cfg.year && !!cfg.firstMonday && !!cfg.lastFriday;

  const top = document.getElementById("currentWeekBlock");
  const list = document.getElementById("allWeeks");
  const empty = document.getElementById("emptyState");
  top.innerHTML = ""; list.innerHTML = "";

  if(!hasConfig){ empty.style.display = "block"; return; } else { empty.style.display = "none"; }

  const weeks = buildWeeks(cfg);
  if(!weeks.length){ empty.style.display="block"; empty.textContent="No valid weeks found. Check First week, Last week, and any skipped weeks."; return; }

  const now = new Date(); const pick = chooseDisplayWeek(weeks, now);
  const displayWeek = pick.week; const currentIdx = pick.idx;

  if(displayWeek){
    const hdr = document.createElement("div"); hdr.className="weekHdr";
    hdr.innerHTML = `<div class="wkTitle">${weekActualLabel(displayWeek)}</div><span class="badge badge--current">Current</span>`;
    top.appendChild(hdr); top.appendChild(renderWeekTable(cfg, displayWeek, links));
  }
  if(currentIdx < weeks.length - 1){
    for(let i=currentIdx+1; i<weeks.length; i++){
      const w = weeks[i]; const block = document.createElement("div"); block.style.marginTop = "22px";
      const hdr = document.createElement("div"); hdr.className="weekHdr";
      hdr.innerHTML = `<div class="wkTitle">${weekActualLabel(w)}</div><span class="badge badge--upcoming">Upcoming</span>`;
      block.appendChild(hdr); block.appendChild(renderWeekTable(cfg, w, links)); list.appendChild(block);
    }
  }
  if (currentIdx > 0 && currentIdx < weeks.length - 1) {
    const divider = document.createElement("div"); divider.className = "sectionRule"; list.appendChild(divider);
  }
  if(currentIdx > 0){
    for(let i=0; i<currentIdx; i++){
      const w = weeks[i]; const block = document.createElement("div"); block.style.marginTop = "22px";
      const hdr = document.createElement("div"); hdr.className="weekHdr";
      hdr.innerHTML = `<div class="wkTitle">${weekActualLabel(w)}</div><span class="badge badge--past">Past</span>`;
      block.appendChild(hdr); block.appendChild(renderWeekTable(cfg, w, links)); list.appendChild(block);
    }
  }
}

/* ===== Gist sync (optional) ===== */
function loadGh(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_GH)||"{}"); }catch{ return {}; } }
function saveGh(obj){ localStorage.setItem(LS_KEY_GH, JSON.stringify(obj)); }
async function gistRequest(method, path, body, token){
  const res = await fetch(`https://api.github.com${path}`, {
    method, headers: { "Accept":"application/vnd.github+json", "Authorization": `Bearer ${token}`, "Content-Type":"application/json" },
    body: body ? JSON.stringify(body) : undefined
  });
  if(!res.ok){ const t = await res.text().catch(()=> ""); throw new Error(`GitHub API ${res.status}: ${t||res.statusText}`); }
  return res.json();
}
function exportAllData(){
  const cfg = loadCfg(); let allLinks = {};
  try{ allLinks = JSON.parse(localStorage.getItem(LS_KEY_LINKS) || "{}"); }catch{}
  return { cfg, linksBySemester: allLinks };
}
function importAllData(payload){
  const { cfg, linksBySemester } = payload || {};
  if(cfg) saveCfg(cfg); if(linksBySemester) localStorage.setItem(LS_KEY_LINKS, JSON.stringify(linksBySemester));
}
async function saveToGist(){
  const gh = loadGh(); const token = (document.getElementById("ghToken").value || gh.token || "").trim();
  if(!token) throw new Error("Missing GitHub Token");
  const data = exportAllData();
  const files = {
    "agenda-config.json": { content: JSON.stringify(data.cfg, null, 2) },
    "agenda-links.json":  { content: JSON.stringify(data.linksBySemester, null, 2) }
  };
  const existingId = document.getElementById("ghGistId").value.trim() || gh.gistId;
  if(existingId){
    const updated = await gistRequest("PATCH", `/gists/${existingId}`, { files }, token);
    const next = { token, gistId: updated.id }; saveGh(next);
    document.getElementById("ghToken").value = token; document.getElementById("ghGistId").value = updated.id;
    return updated.html_url;
  }else{
    const created = await gistRequest("POST", `/gists`, { description:"Weekly Agendas — sync", public:false, files }, token);
    const next = { token, gistId: created.id }; saveGh(next);
    document.getElementById("ghToken").value = token; document.getElementById("ghGistId").value = created.id;
    return created.html_url;
  }
}
async function loadFromGist(){
  const gh = loadGh(); const token = (document.getElementById("ghToken").value || gh.token || "").trim();
  const gistId = (document.getElementById("ghGistId").value || gh.gistId || "").trim();
  if(!token) throw new Error("Missing GitHub Token"); if(!gistId) throw new Error("Missing Gist ID");
  const data = await gistRequest("GET", `/gists/${gistId}`, null, token);
  const files = data.files || {};
  const cfgFile = files["agenda-config.json"]; const linksFile = files["agenda-links.json"];
  if(!cfgFile || !linksFile) throw new Error("Gist missing required files");
  const payload = { cfg: JSON.parse(cfgFile.content), linksBySemester: JSON.parse(linksFile.content) };
  importAllData(payload);
  const next = { token, gistId: data.id }; saveGh(next);
  document.getElementById("ghToken").value = token; document.getElementById("ghGistId").value = data.id;
  return data.html_url;
}

/* ===== Settings UI wiring ===== */
const modal = document.getElementById("settingsModal");
const openSettings = document.getElementById("openSettings");
const closeSettings = document.getElementById("closeSettings");
const semesterSel = document.getElementById("semesterSel");
const yearInput = document.getElementById("yearInput");
const periodInputsWrap = document.getElementById("periodInputs");
const folderChooserArea = document.getElementById("folderChooserArea");
const resetDefaults = document.getElementById("resetDefaults");
const saveBaselineBtn = document.getElementById("saveBaseline");
const loadBaselineBtn = document.getElementById("loadBaseline");
const saveSettings = document.getElementById("saveSettings");
const firstMondayInp = document.getElementById("firstMonday");
const lastFridayInp  = document.getElementById("lastFriday");
const skipRowsWrap   = document.getElementById("skipRows");
const addSkipBtn     = document.getElementById("addSkip");
const ghTokenInp = document.getElementById("ghToken");
const ghGistIdInp = document.getElementById("ghGistId");
const gistSaveBtn = document.getElementById("gistSave");
const gistLoadBtn = document.getElementById("gistLoad");

/* temp state while modal is open */
let tempFolderIds = ["","","","","",""];
let tempFolderNames = ["","","","","",""];

/* UPDATED: render the two-column Period inputs */
function fillPeriodInputs(periods){
  periodInputsWrap.innerHTML = "";
  const left = document.createElement("div");  left.className = "periodCol";
  const right = document.createElement("div"); right.className = "periodCol";

  // Helper to add a row
  const addRow = (col, idx) => {
    const row = document.createElement("div"); row.className="pRow";
    const lab = document.createElement("label"); lab.textContent = `Period ${idx+1}`; lab.setAttribute("for", `p${idx}`);
    const inp = document.createElement("input"); inp.id=`p${idx}`; inp.type="text"; inp.placeholder=""; inp.value = periods[idx] || ""; inp.dataset.idx = idx; inp.className="full";
    row.appendChild(lab); row.appendChild(inp); col.appendChild(row);
  };

  // Periods 1-3 left, 4-6 right
  addRow(left, 0); addRow(left, 1); addRow(left, 2);
  addRow(right,3); addRow(right,4); addRow(right,5);

  const wrap = document.createElement("div"); wrap.className="twoCols";
  wrap.appendChild(left); wrap.appendChild(right);
  periodInputsWrap.appendChild(wrap);
}

function renderFolderChoosers(cfg){
  folderChooserArea.innerHTML = "";
  for(let i=0;i<6;i++){
    const wrap = document.createElement("div"); wrap.className = "folderRow";
    const lab = document.createElement("div"); lab.textContent = `Period ${i+1}`;
    const right = document.createElement("div");
    const currentId = tempFolderIds[i] || cfg.periodFolders[i] || "";
    const currentName = tempFolderNames[i] || "";

    const search = document.createElement("input"); search.type="search"; search.className="long";
    search.placeholder = "Search Drive folders (name)";
    const findBtn = document.createElement("button"); findBtn.className="btn"; findBtn.textContent="Find folder";
    const clearBtn = document.createElement("button"); clearBtn.className="btn secondary"; clearBtn.textContent="Clear";
    const selBox = document.createElement("div");
    if(currentId){
      selBox.className = "folderBadge";
      selBox.innerHTML = `<span>Selected:</span> <code>${currentName || currentId}</code>`;
    }

    const results = document.createElement("div"); results.className="results"; results.style.display="none";

    findBtn.addEventListener("click", async ()=>{
      results.style.display="block"; results.innerHTML = `<div class="resultItem"><em>Searching…</em></div>`;
      try{
        const term = search.value.trim();
        const items = await searchFolders(term);
        if(!items.length){ results.innerHTML = `<div class="resultItem"><em>No folders found.</em></div>`; return; }
        results.innerHTML = "";
        items.forEach(f=>{
          const row = document.createElement("div"); row.className="resultItem";
          const left = document.createElement("div"); left.innerHTML = `<div><strong>${f.name}</strong></div><small>ID: ${f.id}</small>`;
          const pick = document.createElement("button"); pick.className="btn"; pick.textContent="Use this folder";
          pick.addEventListener("click", ()=>{
            tempFolderIds[i] = f.id;
            tempFolderNames[i] = f.name;
            selBox.className = "folderBadge";
            selBox.innerHTML = `<span>Selected:</span> <code>${f.name}</code>`;
            results.style.display="none";
          });
          row.appendChild(left); row.appendChild(pick); results.appendChild(row);
        });
      }catch(e){
        results.innerHTML = `<div class="resultItem"><em>Error: ${e.message||e}</em></div>`;
      }
    });

    clearBtn.addEventListener("click", ()=>{
      tempFolderIds[i] = "";
      tempFolderNames[i] = "";
      selBox.className = "";
      selBox.innerHTML = "";
    });

    right.appendChild(search); right.appendChild(findBtn); right.appendChild(clearBtn); right.appendChild(selBox); right.appendChild(results);
    wrap.appendChild(lab); wrap.appendChild(right);
    folderChooserArea.appendChild(wrap);
  }
}

function renderSkipRows(skipWeeks){ const wrap = document.getElementById("skipRows"); wrap.innerHTML = ""; if(skipWeeks && skipWeeks.length){ skipWeeks.forEach(({from,to})=> addSkipRow(from,to)); } }
function addSkipRow(from="", to=""){
  const row = document.createElement("div"); row.className = "skipRow";
  const fromInp = document.createElement("input"); fromInp.type="date"; fromInp.value = from;
  const toInp = document.createElement("input"); toInp.type="date"; toInp.value = to;
  const delBtn = document.createElement("button"); delBtn.type="button"; delBtn.className="btn secondary"; delBtn.textContent="Remove";
  delBtn.addEventListener("click", ()=> row.remove());
  row.appendChild(fromInp); row.appendChild(toInp); row.appendChild(delBtn); document.getElementById("skipRows").appendChild(row);
}
function collectSkipRows(){
  const rows = Array.from(document.querySelectorAll("#skipRows .skipRow"));
  const out = []; rows.forEach(r=>{ const [fromInp, toInp] = r.querySelectorAll("input"); const from = fromInp?.value || ""; const to = toInp?.value || ""; if(from && to) out.push({from,to}); });
  return out;
}

function openModal(){
  const cfg = loadCfg();
  semesterSel.value = cfg.semester || "";
  yearInput.value = cfg.year || "";
  firstMondayInp.value = cfg.firstMonday || "";
  lastFridayInp.value  = cfg.lastFriday  || "";
  fillPeriodInputs(cfg.periods || ["","","","","",""]);
  renderSkipRows(cfg.skipWeeks || []);

  // temp folder state = current config
  tempFolderIds = [...(cfg.periodFolders || ["","","","","",""])];
  tempFolderNames = ["","","","","",""];
  renderFolderChoosers(cfg);

  const gh = loadGh(); ghTokenInp.value = gh.token || ""; ghGistIdInp.value = gh.gistId || "";
  modal.style.display = "flex";
}
function closeModal(){ modal.style.display = "none"; }

openSettings.addEventListener("click", openModal);
closeSettings.addEventListener("click", closeModal);
modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });

addSkipBtn.addEventListener("click", ()=> addSkipRow());

resetDefaults.addEventListener("click", ()=>{
  saveCfg({...NEUTRAL_CFG}); closeModal(); renderAll();
});
saveBaselineBtn.addEventListener("click", ()=>{
  const current = loadCfg(); saveBaselineCfg(current);
  saveBaselineBtn.textContent = "Baseline Saved ✓"; setTimeout(()=> saveBaselineBtn.textContent = "Save as Baseline", 1500);
});
loadBaselineBtn.addEventListener("click", ()=>{
  const base = loadBaselineCfg();
  if(!base){ loadBaselineBtn.textContent = "No Baseline Found"; setTimeout(()=> loadBaselineBtn.textContent="Load Baseline", 1500); return; }
  saveCfg(base); closeModal(); renderAll();
});
saveSettings.addEventListener("click", ()=>{
  const periods = []; const inputs = document.querySelectorAll("#periodInputs input[type='text']");
  inputs.forEach(inp => { periods[+inp.dataset.idx] = (inp.value || "").trim(); });

  const next = {
    semester: semesterSel.value || "",
    year: (yearInput.value || "").trim(),
    periods,
    periodFolders: tempFolderIds,
    firstMonday: firstMondayInp.value || "",
    lastFriday:  lastFridayInp.value  || "",
    skipWeeks: collectSkipRows(),
    labelsFinalized: true,
  };
  saveCfg(next); closeModal(); renderAll();
});

/* ===== Auth buttons ===== */
document.getElementById("authBtn").addEventListener("click", async ()=>{
  try{ await ensureSignedIn(); }catch(err){ console.error(err); alert("Sign-in failed: "+(err.error||err.message||err)); }
});
document.getElementById("signoutBtn").addEventListener("click", async ()=>{ await signOut(); });

/* Re-render periodically to catch rollover */
setInterval(()=>{ renderAll(); }, 60*1000);

/* ===== Boot: silent sign-in, schedule background refresh, then render ===== */
(async function initOnLoad(){
  if(!localStorage.getItem(LS_KEY_CFG)) saveCfg({...NEUTRAL_CFG});

  try {
    const meta = loadAuthMeta();
    if (meta.granted) {
      const ok = await trySilentSignIn();
      if (ok) { GOOGLE.authed = true; updateAuthUi(); }
    }
  } catch(e) { /* ignore */ }

  scheduleSilentRefresh();
  renderAll();
})();
</script>
</body>
</html>

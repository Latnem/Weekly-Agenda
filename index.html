<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weekly Agendas — Master Template (with Slide Thumbnails)</title>
<style>
  :root{
    --ink:#111;
    --muted:#666;
    --link:#2166c2;
    --ring:#1697BB;
    --bg:#fff;
    --border:#e5e7eb;
  }
  html,body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--ink); background:#fff; margin:0}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px; position:relative}
  header{display:flex;align-items:center;justify-content:space-between;gap:24px;margin-bottom:16px}
  h1{font-weight:700; letter-spacing:.2px; margin:0; white-space: nowrap}
  .iconBtn{
    border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer;
    display:inline-flex; align-items:center; gap:8px; margin-left:16px;
  }
  .iconBtn svg{width:18px;height:18px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 18px}
  .btn{border:1px solid var(--ring); color:#084b5a; padding:8px 12px; border-radius:10px; background:#e9f6fb; cursor:pointer; font-weight:600}
  .btn.secondary{border-color:#ddd;background:#fafafa;color:#222}
  .btn.ghost{border:1px dashed var(--border); background:#fff; color:#333}
  .btn.warn{border-color:#f59e0b;background:#fff7ed;color:#8a4b00}
  .btn:disabled{opacity:.55; cursor:not-allowed}
  .pill{font-size:12px; border:1px solid #ddd; padding:2px 8px; border-radius:999px; color:#333; background:#fafafa}

  /* Empty bubble: left-aligned, compact, with enough space for the message */
  .empty{
    padding:20px 24px;
    border:1px dashed var(--border);
    border-radius:12px;
    color:#555;
    background:#fafafa;
    white-space:nowrap;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    width:fit-content;
    max-width:min(90vw, 620px);
    display:block;
    margin:8px 0;
    box-sizing:border-box;
    text-align:left;
  }

  /* Centered, muted divider line */
  .sectionRule{
    height:2px;
    background:#d1d5db;
    width:min(420px, 90%);
    margin:18px auto 6px;
    border-radius:2px;
  }

  /* Table */
  .grid{border:2px solid #000; border-collapse:collapse; width:100%}
  .grid th,.grid td{border:1px solid #000; padding:10px 12px; vertical-align:top}
  .grid th{font-weight:700; text-align:left; background:#fafafa}
  .sub{font-size:12px;color:#444;margin-top:2px}
  .note{font-size:13px;color:#444;line-height:1.35}
  .weekHdr{display:flex; align-items:baseline; gap:12px; margin:28px 0 8px}
  .wkTitle{font-weight:800; font-size:18px}
  .wkLabel{font-weight:400; font-size:16px; white-space:nowrap}

  /* Pills */
  .badge{
    border:1px solid transparent;
    background:#eee;
    color:#111;
    padding:2px 8px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
  }
  .badge--current{  border-color:#0a7e2a33; background:#e8f8ed; color:#0f5c26; }
  .badge--upcoming{ border-color:#1d4ed833; background:#e6f0ff; color:#1d4ed8; }
  .badge--past{     border-color:#b91c1c33; background:#ffecec; color:#b91c1c; }

  .link{color:var(--link); text-decoration:underline; cursor:pointer}
  .cellActions{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}

  /* Compact fields */
  input[type="search"], input[type="text"], select, input[type="number"], input[type="date"]{
    border:1px solid #ccc; border-radius:10px; padding:8px 10px; width:140px; min-width:120px; outline:none; background:#fff;
  }
  input::placeholder{ color:#888; }
  input:focus, select:focus{border-color:var(--ring); box-shadow:0 0 0 3px #1697bb33}

  .results{margin-top:8px; border:1px solid #e5e5e5; border-radius:10px; overflow:hidden}
  .resultItem{padding:10px 12px; border-top:1px solid #efefef; display:flex; justify-content:space-between; align-items:center; gap:12px}
  .resultItem:first-child{border-top:none}
  .resultItem small{color:#666}
  .colNotes{width:220px}
  .muted{color:#666}
  .time{font-weight:700}

  /* Slides chooser with thumbnails */
  .slidesList{border-top:1px solid #eee; margin-top:8px; padding-top:8px}
  .slideRow{
    display:grid;
    grid-template-columns: 140px 1fr auto;
    align-items:center;
    gap:12px;
    padding:8px 0;
    border-top:1px dashed #eee
  }
  .slideRow:first-child{border-top:none}
  .thumb{
    width:140px; height:79px; /* ~16:9 */
    border:1px solid #e5e7eb; border-radius:8px; object-fit:cover; background:#f3f4f6;
  }
  .thumb.skel{
    animation: pulse 1.2s ease-in-out infinite; filter: saturate(.2) blur(.2px);
  }
  @keyframes pulse {
    0%{ opacity:.65 } 50%{ opacity:1 } 100%{ opacity:.65 }
  }
  .slideTitle{font-size:13px; color:#333}
  .slideMeta{font-size:12px; color:#777}
  .choose{padding:8px 12px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; cursor:pointer}
  .choose:disabled{opacity:.6; cursor:not-allowed}

  /* Modal */
  .modalBackdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50;}
  .modal{
    width:min(900px,92vw); background:#fff; border-radius:16px; border:1px solid var(--border);
    box-shadow:0 10px 30px rgba(0,0,0,.15);
  }
  .modal header{padding:14px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center}
  .modal h2{margin:0; font-size:18px}
  .modal .body{padding:16px}
  .fields{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .field{display:flex; flex-direction:column; gap:6px}
  .field label{font-size:13px; color:#333}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .periodGrid{display:grid; grid-template-columns: 110px 1fr; gap:10px; align-items:center}
  #skipRows{display:flex; flex-direction:column; gap:8px}
  .skipRow{display:flex; gap:8px; align-items:center}
  .modal footer{padding:14px 16px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Click Links to Access Weekly Agendas</h1>
    <button id="openSettings" class="iconBtn" title="Customize master template">
      <!-- gear icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 3.2 17l.06-.06A1.65 1.65 0 0 0 3.59 15a1.65 1.65 0 0 0-1.51-1H2a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 6.04 2.2l.06.06A1.65 1.65 0 0 0 7.92 2h.18A1.65 1.65 0 0 0 9.6 3.59 1.65 1.65 0 0 0 11 5.1V5a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06A2 2 0 1 1 21.8 6.04l-.06.06A1.65 1.65 0 0 0 21.41 7.9 1.65 1.65 0 0 0 23 9.6v.18A1.65 1.65 0 0 0 21.41 11H21a1.65 1.65 0 0 0-1.6 2Z"/>
      </svg>
      Settings
    </button>
  </header>

  <div class="toolbar">
    <button id="authBtn" class="btn">Connect Google Drive</button>
    <button id="signoutBtn" class="btn secondary" disabled>Sign out</button>
    <span id="authState" class="pill">Drive: <strong>signed out</strong></span>
  </div>

  <!-- Current week -->
  <div id="currentWeekBlock"></div>

  <div class="sectionRule"></div>

  <!-- Future (Upcoming) → divider → Past -->
  <div id="allWeeks"></div>

  <div id="emptyState" class="empty" style="display:none;">
    Configure in <strong>Settings</strong> to generate weekly agendas.
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <div class="modal">
    <header>
      <h2 id="settingsTitle">Weekly Agenda Settings</h2>
      <button id="closeSettings" class="iconBtn" title="Close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6 6 18M6 6l12 12"/>
        </svg>
      </button>
    </header>
    <div class="body">
      <div class="fields">
        <div class="field">
          <label for="semesterSel">Semester</label>
          <select id="semesterSel">
            <option value="">— Select —</option>
            <option value="Spring">Spring</option>
            <option value="Fall">Fall</option>
          </select>
        </div>
        <div class="field">
          <label for="yearInput">Year</label>
          <input id="yearInput" type="number" min="2000" max="2100" step="1" placeholder="" />
        </div>

        <div class="field">
          <label for="firstMonday">First week</label>
          <input id="firstMonday" type="date" />
        </div>
        <div class="field">
          <label for="lastFriday">Last week</label>
          <input id="lastFriday" type="date" />
        </div>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Label each period (leave blank for conference)</label>
        <div class="periodGrid" id="periodInputs"></div>
      </div>

      <div class="field" style="margin-top:16px;">
        <label>Weeks to skip (not counted)</label>
        <div id="skipRows"></div>
        <div class="row" style="margin-top:8px;">
          <button id="addSkip" class="btn ghost" type="button">+ Add skip week</button>
        </div>
      </div>
    </div>

    <footer>
      <div class="row">
        <button id="resetDefaults" class="btn secondary">Reset to Default</button>
        <button id="saveBaseline" class="btn warn">Save as Baseline</button>
        <button id="loadBaseline" class="btn secondary">Load Baseline</button>
      </div>
      <div class="row" style="gap:8px; flex-wrap:wrap">
        <input id="ghToken" type="password" placeholder="GitHub Token (gist scope)" style="width:260px" />
        <input id="ghGistId" type="text" placeholder="Gist ID (auto after first save)" style="width:260px" />
        <button id="gistSave" class="btn">Save to Gist</button>
        <button id="gistLoad" class="btn secondary">Load from Gist</button>
      </div>
      <div class="row">
        <button id="saveSettings" class="btn">Save & Regenerate</button>
      </div>
    </footer>
  </div>
</div>

<script>
/* ===== Storage keys ===== */
const LS_KEY_LINKS = "agenda_links_by_semester";
const LS_KEY_CFG   = "agenda_master_template_neutral_v1";
const LS_KEY_BASELINE = "agenda_master_baseline_v1";
const LS_KEY_GH = "agenda_github_sync_v1";

/* ===== Neutral defaults ===== */
const NEUTRAL_CFG = {
  semester: "",
  year: "",
  periods: ["","","","","",""],
  firstMonday: "",
  lastFriday: "",
  skipWeeks: [],
  labelsFinalized: false
};

/* ===== Utilities ===== */
const dayMs = 24*60*60*1000;
function toDateAtMidnight(s){ if(!s) return null; const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d,0,0,0,0); }
function addDays(date,n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
function overlaps(aStart,aEnd,bStart,bEnd){ return !(aEnd < bStart || aStart > bEnd); }
function mondayOf(d){ const nd=new Date(d); const w=(nd.getDay()+6)%7; nd.setDate(nd.getDate()-w); nd.setHours(0,0,0,0); return nd; }
function fmtMonthLong(d){ return d.toLocaleDateString(undefined,{month:"long"}); }
function fmtDay(d){ return d.getDate(); }
function formatRangeFull(a,b){
  if(a.getMonth()===b.getMonth() && a.getFullYear()===b.getFullYear()){
    return `${fmtMonthLong(a)} ${fmtDay(a)}–${fmtDay(b)}`;
  } else {
    return `${fmtMonthLong(a)} ${fmtDay(a)}–${fmtMonthLong(b)} ${fmtDay(b)}`;
  }
}

/* ===== Baseline helpers ===== */
function saveBaselineCfg(cfg){ localStorage.setItem(LS_KEY_BASELINE, JSON.stringify(cfg)); }
function loadBaselineCfg(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY_BASELINE) || "null"); }
  catch{ return null; }
}

/* ===== Config IO ===== */
function loadCfg(){
  const raw = localStorage.getItem(LS_KEY_CFG);
  if(!raw) return {...NEUTRAL_CFG};
  try{
    const cfg = JSON.parse(raw);
    cfg.semester = cfg.semester ?? "";
    cfg.year = cfg.year ?? "";
    if(!Array.isArray(cfg.periods) || cfg.periods.length!==6) cfg.periods = ["","","","","",""];
    cfg.firstMonday = cfg.firstMonday ?? "";
    cfg.lastFriday  = cfg.lastFriday  ?? "";
    if(!Array.isArray(cfg.skipWeeks)) cfg.skipWeeks = [];
    cfg.labelsFinalized = !!cfg.labelsFinalized;
    return cfg;
  }catch{ return {...NEUTRAL_CFG}; }
}
function saveCfg(cfg){ localStorage.setItem(LS_KEY_CFG, JSON.stringify(cfg)); }
function keyForLinks(cfg){ return `${cfg.semester || "Semester"}-${cfg.year || "Year"}`; }
function loadLinksFor(cfg){
  try{ const all = JSON.parse(localStorage.getItem(LS_KEY_LINKS) || "{}"); return all[keyForLinks(cfg)] || {}; }
  catch{ return {}; }
}
function saveLinksFor(cfg, linksObj){
  const raw = localStorage.getItem(LS_KEY_LINKS);
  let all = {};
  try{ all = raw ? JSON.parse(raw) : {}; }catch{ all = {}; }
  all[keyForLinks(cfg)] = linksObj;
  localStorage.setItem(LS_KEY_LINKS, JSON.stringify(all));
}

/* ===== Build weeks (strict Monday→Friday) ===== */
function buildWeeks(cfg){
  const startRaw = toDateAtMidnight(cfg.firstMonday);
  const endRaw   = toDateAtMidnight(cfg.lastFriday);
  if(!startRaw || !endRaw || startRaw > endRaw) return [];

  const startMon = mondayOf(startRaw);
  const endFri   = addDays(mondayOf(endRaw), 4);

  const skipRanges = (cfg.skipWeeks||[]).map(({from,to})=>{
    const sRaw = toDateAtMidnight(from);
    const eRaw = toDateAtMidnight(to);
    if(!sRaw || !eRaw) return null;
    const s = mondayOf(sRaw);
    const e = addDays(mondayOf(eRaw), 4);
    return {from:s, to:e};
  }).filter(Boolean);

  const weeks=[];
  let weekNum=0;

  for(let mon=new Date(startMon); mon <= endFri; mon = addDays(mon,7)){
    const fri = addDays(mon,4);
    const isSkipped = skipRanges.some(r => overlaps(mon, fri, r.from, r.to));
    if(isSkipped) continue;
    weekNum++;
    weeks.push({ n:weekNum, monday:new Date(mon), friday:new Date(fri) });
  }
  return weeks;
}

/* ===== Auto-advance at Saturday 12:00 AM ===== */
function chooseDisplayWeek(weeks, now=new Date()){
  if(!weeks.length) return { week:null, idx:-1, badge:"" };
  const mon = mondayOf(now);
  let idx = weeks.findIndex(w => +w.monday === +mon);
  if(idx !== -1){
    const friMidnight = new Date(weeks[idx].friday); 
    friMidnight.setHours(0,0,0,0);
    const satMidnight = new Date(friMidnight.getTime() + dayMs);
    if (now >= satMidnight) idx = Math.min(idx + 1, weeks.length - 1);
  } else {
    if(now < weeks[0].monday) idx = 0;
    else idx = weeks.length - 1;
  }
  return { week: weeks[idx], idx, badge: "Current" };
}

/* ===== Google Drive + Slides (with thumbnails) ===== */
const GOOGLE = {
  API_KEY: "AIzaSyDWnOao76tK1ecBGfL21ZLxBDvChqlGrx0",
  CLIENT_ID: "462034083093-75pc8bgfieivcrkc6275vgahg44qhvvh.apps.googleusercontent.com",
  DISCOVERY_DOCS: [
    "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
    "https://slides.googleapis.com/$discovery/rest?version=v1"
  ],
  SCOPES: "https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/presentations.readonly",
  authed: false,
};

let gapiLoaded=false;
function updateAuthUi(){
  document.getElementById("authState").innerHTML = "Drive: <strong>"+(GOOGLE.authed?"signed in":"signed out")+"</strong>";
  document.getElementById("signoutBtn").disabled = !GOOGLE.authed;
}
function loadGapi(){
  return new Promise((res, rej)=>{
    if(gapiLoaded) return res();
    const s=document.createElement("script");
    s.src="https://apis.google.com/js/api.js";
    s.onload=()=>{ gapiLoaded=true; res(); };
    s.onerror=rej;
    document.head.appendChild(s);
  });
}
async function initGapi(){
  await loadGapi();
  await new Promise(r=>gapi.load("client:auth2", r));
  await gapi.client.init({
    apiKey: GOOGLE.API_KEY,
    clientId: GOOGLE.CLIENT_ID,
    discoveryDocs: GOOGLE.DISCOVERY_DOCS,
    scope: GOOGLE.SCOPES
  });
  const auth = gapi.auth2.getAuthInstance();
  GOOGLE.authed = auth.isSignedIn.get();
  auth.isSignedIn.listen(isIn=>{ GOOGLE.authed=isIn; updateAuthUi(); });
  updateAuthUi();
}
async function ensureSignedIn(){
  if(!gapiLoaded) await initGapi();
  const auth = gapi.auth2.getAuthInstance();
  if(!auth.isSignedIn.get()) await auth.signIn();
  return true;
}
async function signOut(){
  if(!gapiLoaded) return;
  await gapi.auth2.getAuthInstance().signOut();
}
async function searchSlides(hint){
  await ensureSignedIn();
  const q = [
    "mimeType='application/vnd.google-apps.presentation'",
    "trashed=false",
    hint ? `name contains '${hint.replace(/'/g,"\\'")}'` : null
  ].filter(Boolean).join(" and ");
  const res = await gapi.client.drive.files.list({
    q, pageSize: 10,
    fields: "files(id,name,modifiedTime,webViewLink)"
  });
  return res.result.files || [];
}

/* Build a direct link to a specific slide */
function slideLink(fileId, pageObjectId){
  return `https://docs.google.com/presentation/d/${fileId}/edit#slide=id.${pageObjectId}`;
}

/* Human title from a slide (TITLE placeholder), else "Slide N" */
function titleFromSlide(slide, index){
  const elems = slide.pageElements || [];
  for(const el of elems){
    const shape = el.shape;
    if(!shape) continue;
    const ph = shape.placeholder;
    if(ph && ph.type === "TITLE" && shape.text && shape.text.textElements){
      let s = "";
      for(const te of shape.text.textElements){
        if(te.textRun && te.textRun.content) s += te.textRun.content;
      }
      s = (s || "").trim();
      if(s) return s;
    }
  }
  return `Slide ${index+1}`;
}

/* Get a thumbnail URL for a slide (PNG, MEDIUM). Falls back to SMALL on error. */
async function getSlideThumb(presentationId, pageObjectId){
  try{
    const res = await gapi.client.slides.presentations.pages.getThumbnail({
      presentationId,
      pageObjectId,
      "thumbnailProperties.mimeType":"PNG",
      "thumbnailProperties.thumbnailSize":"MEDIUM"
    });
    return res.result.contentUrl;
  }catch(e){
    try{
      const res2 = await gapi.client.slides.presentations.pages.getThumbnail({
        presentationId,
        pageObjectId,
        "thumbnailProperties.mimeType":"PNG",
        "thumbnailProperties.thumbnailSize":"SMALL"
      });
      return res2.result.contentUrl;
    }catch(err){
      return ""; // no thumb; UI will show gray skeleton box
    }
  }
}

/* ===== Label helpers ===== */
function weekActualLabel(w){ return formatRangeFull(w.monday, w.friday); }
function headerActualLabel(cfg){
  const sem = cfg.semester || "Semester";
  const yr  = cfg.year || "Year";
  return `${sem} ${yr}`;
}

/* ===== Rendering ===== */
function renderWeekTable(cfg, w, links){
  const table = document.createElement("table");
  table.className="grid";
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");

  const t0 = document.createElement("th");
  t0.textContent = headerActualLabel(cfg);
  trh.appendChild(t0);

  const PERIOD_TIMES = [
    { title:"8:30-9:26",  sub:"8:30-9:12" },
    { title:"9:33-10:29", sub:"9:19-10:01" },
    { title:"10:46-11:42",sub:"10:55-11:37" },
    { title:"11:49-12:57",sub:"11:44-12:26" },
    { title:"1:34-2:30",  sub:"1:03-1:45" },
    { title:"2:37-3:33",  sub:"1:52-2:34" },
  ];
  PERIOD_TIMES.forEach(p=>{
    const th=document.createElement("th");
    th.innerHTML = `<div class="time">${p.title}</div><div class="sub">${p.sub}</div>`;
    trh.appendChild(th);
  });

  const thNotes=document.createElement("th"); thNotes.textContent="Notes:"; thNotes.className="colNotes";
  trh.appendChild(thNotes);

  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  const tr = document.createElement("tr");

  // First column, second row: Week N label (unbold, single line)
  const label = document.createElement("td");
  label.innerHTML = `<div class="wkLabel">Week ${w.n}</div>`;
  tr.appendChild(label);

  // Period cells
  cfg.periods.forEach((periodLabel,idx)=>{
    const td=document.createElement("td");
    const saved = links?.[w.n]?.[idx];

    if(!periodLabel){
      td.innerHTML = `<div class="muted">Conference</div>`;
      tr.appendChild(td);
      return;
    }

    if(saved){
      const href = saved.slideId ? slideLink(saved.id, saved.slideId) : (saved.url || "#");
      td.innerHTML = `<div><a class="link" href="${href}" target="_blank" rel="noopener">${periodLabel}</a></div>`;
    }else{
      td.innerHTML = `<div class="muted">${periodLabel}</div>`;
    }

    const box = document.createElement("div"); box.className="cellActions";
    const search = document.createElement("input");
    search.type="search";
    search.placeholder = `${periodLabel}`;
    search.value = "";

    const attachBtn = document.createElement("button");
    attachBtn.className="btn";
    attachBtn.textContent="Link";

    const results = document.createElement("div"); results.className="results"; results.style.display="none";

    attachBtn.addEventListener("click", async ()=>{
      results.style.display="block";
      results.innerHTML = `<div class="resultItem"><em>Searching…</em></div>`;
      try{
        const hintRaw = (search.value.trim() || search.placeholder || `Week ${w.n}`);
        const files = await searchSlides(hintRaw);
        if(!files.length){
          results.innerHTML = `<div class="resultItem"><em>No matches found.</em></div>`;
          return;
        }
        results.innerHTML = "";

        files.forEach((f)=>{
          const row = document.createElement("div");
          row.className="resultItem";
          const left = document.createElement("div");
          left.innerHTML = `<div><strong>${f.name}</strong></div><small>Last modified ${new Date(f.modifiedTime).toLocaleDateString()}</small>`;
          const pick = document.createElement("button");
          pick.className="btn";
          pick.textContent="Select";
          row.appendChild(left); row.appendChild(pick);
          results.appendChild(row);

          // When user clicks "Select", fetch slides and show a nested chooser with thumbnails
          pick.addEventListener("click", async ()=>{
            pick.disabled = true; pick.textContent = "Loading slides…";
            try{
              const pres = await gapi.client.slides.presentations.get({ presentationId: f.id });
              const slides = pres.result.slides || [];
              const nested = document.createElement("div");
              nested.className = "slidesList";

              if(!slides.length){
                nested.innerHTML = `<div class="slideRow"><span class="slideTitle">No slides found</span></div>`;
              } else {
                // Build rows first with skeleton thumbnails, then lazy-load images
                const rows = slides.map((s, i)=>{
                  const sr = document.createElement("div");
                  sr.className = "slideRow";

                  const img = document.createElement("img");
                  img.className = "thumb skel";
                  img.alt = "Slide thumbnail";
                  img.loading = "lazy";

                  const meta = document.createElement("div");
                  const human = titleFromSlide(s, i);
                  meta.innerHTML = `<div class="slideTitle">${human}</div><div class="slideMeta">#${i+1}</div>`;

                  const chooseBtn = document.createElement("button");
                  chooseBtn.className = "choose";
                  chooseBtn.textContent = "Choose";
                  chooseBtn.addEventListener("click", ()=>{
                    const all=loadLinksFor(cfg);
                    all[w.n]??={};
                    all[w.n][idx] = {
                      id: f.id,
                      name: f.name,
                      slideId: s.objectId,
                      url: f.webViewLink
                    };
                    saveLinksFor(cfg, all);
                    // Update cell UI
                    td.querySelector(".muted")?.remove();
                    td.querySelector("div")?.remove();
                    const linkDiv=document.createElement("div");
                    linkDiv.innerHTML = `<a class="link" href="${slideLink(f.id, s.objectId)}" target="_blank" rel="noopener">${periodLabel}</a>`;
                    td.insertBefore(linkDiv, box);
                    results.style.display="none";
                  });

                  sr.appendChild(img);
                  sr.appendChild(meta);
                  sr.appendChild(chooseBtn);
                  nested.appendChild(sr);

                  // Async load thumbnail
                  (async ()=>{
                    const url = await getSlideThumb(f.id, s.objectId);
                    if(url){
                      img.src = url;
                      img.classList.remove("skel");
                    } else {
                      // leave skeleton style as a subtle placeholder
                    }
                  })();

                  return sr;
                });
              }
              row.insertAdjacentElement("afterend", nested);
              pick.textContent = "Slides loaded";
              setTimeout(()=>{ pick.textContent="Select"; pick.disabled=false; }, 800);
            }catch(e){
              pick.textContent = "Select";
              pick.disabled = false;
              alert("Failed to load slides: " + (e.result?.error?.message || e.message || e));
            }
          });
        });
      }catch(err){
        results.innerHTML = `<div class="resultItem"><em>Error: ${err.message||err}</em></div>`;
      }
    });

    box.appendChild(search);
    box.appendChild(attachBtn);
    td.appendChild(box);
    td.appendChild(results);
    tr.appendChild(td);
  });

  // Notes
  const tNotes=document.createElement("td");
  tNotes.innerHTML = `<div class="note">
    *Agendas<br>*Lessons<br>*Grades<br>*e-Calendar<br>*Announcements<br>*Services
  </div>`;
  tr.appendChild(tNotes);

  tbody.appendChild(tr);
  table.appendChild(tbody);
  return table;
}

function renderAll(){
  const cfg = loadCfg();
  const links = loadLinksFor(cfg);

  const hasConfig = !!cfg.semester && !!cfg.year && !!cfg.firstMonday && !!cfg.lastFriday;

  const top = document.getElementById("currentWeekBlock");
  const list = document.getElementById("allWeeks");
  const empty = document.getElementById("emptyState");
  top.innerHTML = ""; list.innerHTML = "";

  if(!hasConfig){
    empty.style.display = "block";
    return;
  } else {
    empty.style.display = "none";
  }

  const weeks = buildWeeks(cfg);
  if(!weeks.length){
    empty.style.display = "block";
    empty.textContent = "No valid weeks found. Check First week, Last week, and any skipped weeks.";
    return;
  }

  const now = new Date();
  const pick = chooseDisplayWeek(weeks, now);
  const displayWeek = pick.week;
  const currentIdx = pick.idx;

  /* Current */
  if(displayWeek){
    const hdr = document.createElement("div");
    hdr.className = "weekHdr";
    const title = weekActualLabel(displayWeek);
    hdr.innerHTML = `<div class="wkTitle">${title}</div><span class="badge badge--current">Current</span>`;
    top.appendChild(hdr);
    top.appendChild(renderWeekTable(cfg, displayWeek, links));
  }

  /* Upcoming (future weeks) */
  if(currentIdx < weeks.length - 1){
    for(let i=currentIdx+1; i<weeks.length; i++){
      const w = weeks[i];
      const block = document.createElement("div");
      block.style.marginTop = "22px";
      const hdr = document.createElement("div"); hdr.className="weekHdr";
      hdr.innerHTML = `<div class="wkTitle">${weekActualLabel(w)}</div><span class="badge badge--upcoming">Upcoming</span>`;
      block.appendChild(hdr);
      block.appendChild(renderWeekTable(cfg, w, links));
      list.appendChild(block);
    }
  }

  /* Divider between Upcoming and Past (centered, muted) */
  if (currentIdx > 0 && currentIdx < weeks.length - 1) {
    const divider = document.createElement("div");
    divider.className = "sectionRule";
    list.appendChild(divider);
  }

  /* Past weeks */
  if(currentIdx > 0){
    for(let i=0; i<currentIdx; i++){
      const w = weeks[i];
      const block = document.createElement("div");
      block.style.marginTop = "22px";
      const hdr = document.createElement("div"); hdr.className="weekHdr";
      hdr.innerHTML = `<div class="wkTitle">${weekActualLabel(w)}</div><span class="badge badge--past">Past</span>`;
      block.appendChild(hdr);
      block.appendChild(renderWeekTable(cfg, w, links));
      list.appendChild(block);
    }
  }
}

/* ===== GitHub Gist sync (optional) ===== */
function loadGh(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_GH)||"{}"); }catch{ return {}; } }
function saveGh(obj){ localStorage.setItem(LS_KEY_GH, JSON.stringify(obj)); }
async function gistRequest(method, path, body, token){
  const res = await fetch(`https://api.github.com${path}`, {
    method,
    headers: {
      "Accept": "application/vnd.github+json",
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: body ? JSON.stringify(body) : undefined
  });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`GitHub API ${res.status}: ${t||res.statusText}`);
  }
  return res.json();
}
function exportAllData(){
  const cfg = loadCfg();
  let allLinks = {};
  try{ allLinks = JSON.parse(localStorage.getItem(LS_KEY_LINKS) || "{}"); }catch{}
  return { cfg, linksBySemester: allLinks };
}
function importAllData(payload){
  const { cfg, linksBySemester } = payload || {};
  if(cfg) saveCfg(cfg);
  if(linksBySemester) localStorage.setItem(LS_KEY_LINKS, JSON.stringify(linksBySemester));
}
async function saveToGist(){
  const gh = loadGh();
  const token = (document.getElementById("ghToken").value || gh.token || "").trim();
  if(!token) throw new Error("Missing GitHub Token");
  const data = exportAllData();
  const files = {
    "agenda-config.json": { content: JSON.stringify(data.cfg, null, 2) },
    "agenda-links.json":  { content: JSON.stringify(data.linksBySemester, null, 2) }
  };
  const existingId = document.getElementById("ghGistId").value.trim() || gh.gistId;
  if(existingId){
    const updated = await gistRequest("PATCH", `/gists/${existingId}`, { files }, token);
    const next = { token, gistId: updated.id };
    saveGh(next);
    document.getElementById("ghToken").value = token;
    document.getElementById("ghGistId").value = updated.id;
    return updated.html_url;
  }else{
    const created = await gistRequest("POST", `/gists`, {
      description: "Weekly Agendas — sync",
      public: false,
      files
    }, token);
    const next = { token, gistId: created.id };
    saveGh(next);
    document.getElementById("ghToken").value = token;
    document.getElementById("ghGistId").value = created.id;
    return created.html_url;
  }
}
async function loadFromGist(){
  const gh = loadGh();
  const token = (document.getElementById("ghToken").value || gh.token || "").trim();
  const gistId = (document.getElementById("ghGistId").value || gh.gistId || "").trim();
  if(!token) throw new Error("Missing GitHub Token");
  if(!gistId) throw new Error("Missing Gist ID");
  const data = await gistRequest("GET", `/gists/${gistId}`, null, token);
  const files = data.files || {};
  const cfgFile = files["agenda-config.json"];
  const linksFile = files["agenda-links.json"];
  if(!cfgFile || !linksFile) throw new Error("Gist missing required files");
  const payload = {
    cfg: JSON.parse(cfgFile.content),
    linksBySemester: JSON.parse(linksFile.content)
  };
  importAllData(payload);
  const next = { token, gistId: data.id };
  saveGh(next);
  document.getElementById("ghToken").value = token;
  document.getElementById("ghGistId").value = data.id;
  return data.html_url;
}

/* ===== Settings modal wiring ===== */
const modal = document.getElementById("settingsModal");
const openSettings = document.getElementById("openSettings");
const closeSettings = document.getElementById("closeSettings");
const semesterSel = document.getElementById("semesterSel");
const yearInput = document.getElementById("yearInput");
const periodInputsWrap = document.getElementById("periodInputs");
const resetDefaults = document.getElementById("resetDefaults");
const saveBaselineBtn = document.getElementById("saveBaseline");
const loadBaselineBtn = document.getElementById("loadBaseline");
const saveSettings = document.getElementById("saveSettings");
const firstMondayInp = document.getElementById("firstMonday");
const lastFridayInp  = document.getElementById("lastFriday");
const skipRowsWrap   = document.getElementById("skipRows");
const addSkipBtn     = document.getElementById("addSkip");
const ghTokenInp = document.getElementById("ghToken");
const ghGistIdInp = document.getElementById("ghGistId");
const gistSaveBtn = document.getElementById("gistSave");
const gistLoadBtn = document.getElementById("gistLoad");

function fillPeriodInputs(periods){
  periodInputsWrap.innerHTML = "";
  for(let i=0;i<6;i++){
    const lbl = document.createElement("div");
    lbl.textContent = `Period ${i+1}`;
    const inp = document.createElement("input");
    inp.type="text";
    inp.placeholder = "";
    inp.value = periods[i] || "";
    inp.dataset.idx = i;
    periodInputsWrap.appendChild(lbl);
    periodInputsWrap.appendChild(inp);
  }
}
function renderSkipRows(skipWeeks){
  skipRowsWrap.innerHTML = "";
  if(skipWeeks && skipWeeks.length){
    skipWeeks.forEach(({from,to})=> addSkipRow(from,to));
  }
}
function addSkipRow(from="", to=""){
  const row = document.createElement("div");
  row.className = "skipRow";
  const fromInp = document.createElement("input");
  fromInp.type="date"; fromInp.value = from;
  const toInp = document.createElement("input");
  toInp.type="date"; toInp.value = to;
  const delBtn = document.createElement("button");
  delBtn.type="button"; delBtn.className="btn secondary"; delBtn.textContent="Remove";
  delBtn.addEventListener("click", ()=> row.remove());
  row.appendChild(fromInp); row.appendChild(toInp); row.appendChild(delBtn);
  skipRowsWrap.appendChild(row);
}
function collectSkipRows(){
  const rows = Array.from(skipRowsWrap.querySelectorAll(".skipRow"));
  const out = [];
  rows.forEach(r=>{
    const [fromInp, toInp] = r.querySelectorAll("input");
    const from = fromInp?.value || "";
    const to   = toInp?.value || "";
    if(from && to) out.push({from,to});
  });
  return out;
}
function openModal(){
  const cfg = loadCfg();
  semesterSel.value = cfg.semester || "";
  yearInput.value = cfg.year || "";
  firstMondayInp.value = cfg.firstMonday || "";
  lastFridayInp.value  = cfg.lastFriday  || "";
  fillPeriodInputs(cfg.periods || ["","","","","",""]);
  renderSkipRows(cfg.skipWeeks || []);
  const gh = loadGh();
  ghTokenInp.value = gh.token || "";
  ghGistIdInp.value = gh.gistId || "";
  modal.style.display = "flex";
}
function closeModal(){ modal.style.display = "none"; }

openSettings.addEventListener("click", openModal);
closeSettings.addEventListener("click", closeModal);
modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });

addSkipBtn.addEventListener("click", ()=> addSkipRow());

resetDefaults.addEventListener("click", ()=>{
  saveCfg({...NEUTRAL_CFG});
  closeModal();
  renderAll();
});

/* Baseline actions */
saveBaselineBtn.addEventListener("click", ()=>{
  const current = loadCfg();
  saveBaselineCfg(current);
  saveBaselineBtn.textContent = "Baseline Saved ✓";
  setTimeout(()=> saveBaselineBtn.textContent = "Save as Baseline", 1500);
});
loadBaselineBtn.addEventListener("click", ()=>{
  const base = loadBaselineCfg();
  if(!base){ loadBaselineBtn.textContent = "No Baseline Found"; setTimeout(()=> loadBaselineBtn.textContent="Load Baseline", 1500); return; }
  saveCfg(base);
  closeModal();
  renderAll();
});

saveSettings.addEventListener("click", ()=>{
  const periods = [];
  const inputs = periodInputsWrap.querySelectorAll("input[type='text']");
  inputs.forEach(inp => { periods[+inp.dataset.idx] = (inp.value || "").trim(); });

  const next = {
    semester: semesterSel.value || "",
    year: (yearInput.value || "").trim(),
    periods,
    firstMonday: firstMondayInp.value || "",
    lastFriday:  lastFridayInp.value  || "",
    skipWeeks: collectSkipRows(),
    labelsFinalized: true,
  };
  saveCfg(next);
  closeModal();
  renderAll();
});

/* Gist buttons */
gistSaveBtn.addEventListener("click", async ()=>{
  gistSaveBtn.disabled = true; gistSaveBtn.textContent = "Saving…";
  try{
    await saveToGist();
    gistSaveBtn.textContent = "Saved ✓";
    setTimeout(()=> gistSaveBtn.textContent = "Save to Gist", 1200);
  }catch(e){
    alert(e.message||e);
    gistSaveBtn.textContent = "Save to Gist";
  }finally{ gistSaveBtn.disabled = false; }
});
gistLoadBtn.addEventListener("click", async ()=>{
  gistLoadBtn.disabled = true; gistLoadBtn.textContent = "Loading…";
  try{
    await loadFromGist();
    gistLoadBtn.textContent = "Loaded ✓";
    closeModal(); renderAll();
    setTimeout(()=> gistLoadBtn.textContent = "Load from Gist", 1200);
  }catch(e){
    alert(e.message||e);
    gistLoadBtn.textContent = "Load from Gist";
  }finally{ gistLoadBtn.disabled = false; }
});

/* ===== Auth controls ===== */
document.getElementById("authBtn").addEventListener("click", async ()=>{
  try{ await ensureSignedIn(); }catch(err){ alert("Sign-in failed: "+(err.error||err)); }
});
document.getElementById("signoutBtn").addEventListener("click", async ()=>{ await signOut(); });

/* ===== Re-render every minute to catch Saturday rollover ===== */
setInterval(()=>{ renderAll(); }, 60*1000);

/* ===== Boot ===== */
(function initOnLoad(){
  if(!localStorage.getItem(LS_KEY_CFG)){
    saveCfg({...NEUTRAL_CFG});
  }
  renderAll();
})();
</script>
</body>
</html>
